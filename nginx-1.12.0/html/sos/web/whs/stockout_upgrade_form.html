<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>出库_升级</title>
<link rel="stylesheet" type="text/css" href="../../css/base.css" />
<link rel="stylesheet" type="text/css" href="../../css/common.css" />
<link rel="stylesheet" type="text/css" href="../../css/form.css"><link rel="stylesheet" type="text/css" href="../../css/window.css">
<link rel="stylesheet" type="text/css" href="../../css/pup.css">
<link rel="stylesheet" type="text/css" href="../../css/tabs.css">
<link rel="stylesheet" type="text/css" href="../../css/datagrid.css">
<link rel="stylesheet" type="text/css" href="../../css/gbossIframe.css">
<style>
fieldset div div.panel span{
  width: 30px;
  padding: 0 0 0 0;
}
</style>
</head>
<body>
 <div id="nw_document_all">
	<form id='form_stockout_upgrade'method='post' class="form" style="width:880px;">
		<div class='title'>升级出库信息></div>
		<fieldset style="width:860px;">
            <div class="panel" style="position: relative;">
                <span>出库单号:</span>
                <input type='text' id="code" name='code' placeholder="请输入出库单号"  style="width:165px;" disabled="disabled" />
                
                <span>出库日期:</span>
                <input type='date' id="stamp" name='stamp' style="width:155px;" disabled="disabled" />
                
                <span style="width:76px;">客户:</span>
                <input name="customerName" id="customerName" list="customerDataList"style="width:150px;vertical-align:top;" autocomplete="on" autofocus="autofocus"/>
                <input type="hidden" name="customerId" id="customerId" />
                <datalist id="customerDataList"></datalist>
   				<a id="acustomer" href="javascript:void(0);" ><img alt="查询" src="images/form_search.png" title="查询" ></a>
 			</div>
 			
              <div class="panel">   
               <span style="vertical-align:top;">经办人:</span>
                 <input name="managersName" id="managersName" required="true" list="userDataList" style="width:165px;vertical-align:top;" autocomplete="on" autofocus="autofocus"/>
                <input type="hidden" name="managersId" id="managersId" required="true" />
                <datalist id="userDataList"></datalist>
                <span id="borrowedNum" style="vertical-align:top;width:10px;color: red"></span>
       			
       			<span style="vertical-align:top;width: 58px;">收据票号:</span>
                <input type="text" id="receiptNo"  name="receiptNo" style="width:155px;vertical-align:top;" autocomplete="on"/>
                
                <span style="vertical-align:top;width: 76px;">总费用:</span>
                <input type="text" id="peopleMoney"  name="peopleMoney" pattern="^\d+\.{0,1}\d*$" style="width:150px;vertical-align:top;" value="0" oninvalid='setCustomValidity("请输入数字!")' />
              </div>
               <div class="panel">  
                <span style="vertical-align:top;">备注:</span>
                 <textarea  id="remark" name='remark'  style="width:672px;" rows="2" ></textarea>
            </div>
        </fieldset>
        
		<div class='title'>升级出库明细></div>
		<fieldset style="width:860px;">
			<div id="stockout_detail_panel" style="min-height:260px;max-height:356px; overflow-y:auto">
				<div class="panel">
			        <span>成品:</span>
	                <input type='text' name='productName1' list="productDataList"  placeholder="请输入成品名称/编码" autocomplete=false  style="width:300px;" />
	                <input type="hidden" name="productId1" />
	                <font color="red">*输入成品查询配件</font>
	              <!--   <div class='submit' style="display: inline-block;">
		            <button id="btn_getparts" type="button" style="">查询配件</button>
		            </div>  -->  
		        </div>
				<div id="div_stockout_detail" class="panel">
	                 <span >商品:</span>
	                <input type='text' name='productName' list="productDataList" required="true" placeholder="请输入商品名称/编码" autocomplete=false  style="width:140px;" />
	                <input type="hidden" name="productId" />
	                
	                <span>编码:</span>
	                <input type='text' name='productCode' disabled="disabled" style="width:106px;"/>
	              
	                <span >规格:</span>
	                <input type='text' name='norm' placeholder="规格" disabled="disabled" style="width:150px;"  />
	             
	                <span >数量:</span>
	                <input type='number' name='num' placeholder="数字" required="true" pattern="^[+]?[1-9]+\d*$" style="width:50px;"  onkeyup="this.value=this.value.replace(/\D/g,'')" value="1"/>
	                <!-- <span >价格:</span> -->
	                <input type='hidden' name='contractId'/>
	                <input type='hidden' name='price'/>
	                
	                  <span>费用:</span>
                    <input type="text" name="money" value="0" pattern="^\d+\.{0,1}\d*$" style="width:40px;vertical-align:top;" oninvalid='setCustomValidity("请输入数字!")' />
                
	                <span >备注:</span>
	                <input type='text' name='remark' style="width:90px;" />
	          
	                <a href="javascript:void(0);" ><img alt="增加明细" src="../../images/form_add.png" title="增加明细" style="vertical-align:middle"></a>
	            </div>
	            
			</div>
            <datalist id="productDataList">
            </datalist>
        </fieldset>

        <fieldset style="width:860px;border-top:0px;">	
	        <div class='submit'>
	        	<input type="checkbox" id="chk_writeoff_now" style="vertical-align:middle;" checked="checked"/> <span style="width:auto;">立即核销</span>
	            <button id="btn_stockin_upgrade1" type="submit"style="width:60px;">提交</button>
	            <button id="btn_stockin_upgrade2" type="submit" style="width:112px;">提交并打印</button>
	             <button id="mycancel" type="button">重置</button>
	             <button id="btn_print" type="button" style="display: none;">打印</button>
	        </div>
        </fieldset>

	</form>
 </div>
	<!-- 打印iframe -->
	<iframe id="ifm_print" name="ifm_print" style="display: none"></iframe>
</body>
<script type="text/javascript" src="../../jscript/jquery-2.0.3.min.js"></script>
	<script type="text/javascript" src="../../jscript/html5.js"></script>
	<script type="text/javascript" src="../../jscript/index.js"></script>
	<script type="text/javascript" src="../../jscript/form.js"></script><script type="text/javascript" src="../../jscript/window.js"></script>
	<script type="text/javascript" src="../../jscript/tab.js"></script>
	<script type="text/javascript" src="../../jscript/datagrid.js"></script>
	<script type="text/javascript" src="../../jscript/pup.js" ></script>
<script type="text/javascript">
(function($){
	var flag = 0;
	var productIdDataList=[];//商品数组 key:商品名称,value:productId
	var userDataList = {};//经办人 key:name,value:id
	var customerDataList={};//最终客户
	//填充出库单号
	$.ajax({
		  type : 'POST', 
		  async: false,   
		  url : '../../stock/getStockInOutNo',   
		  data: {isIn:false},
		  dataType : 'json', 
		  success : function(data) {
			  if(data){
				  if(data.success){
					  $('input,select,textarea,a,button').removeAttr('disabled');
				  	  $("#code").val(data.code);
				  	 //入库日期
				      $("#stamp").val(new Date().format('yyyy-MM-dd'));	
				     //出库单号、日期、规格重新设置disabled
				      $('#code,#stamp,input[name=norm]').attr('disabled',true);
				  }else{
					  if(data.msg&&data.msg.indexOf('仓库正在盘点')>-1){
						$('input,select,textarea,a,button').attr('disabled',true);
					  }
					  $(document).sgPup({message:'message_info',text: data.msg,cfn:function(){
							$('input,select,textarea,a,button').attr('disabled',true);
						}}); 
				  }
			  }
		  } 
	});
	//自动查询最终客户
	var checkCustomer = function(){
	/* 	var text=this.value;
		text = text.replace(/\s/g,''); //去除空格
		if(text!=this.value){//有空格
			this.value=text;
			$(this).trigger('change');
			return false;
		} */
		var params = {};
		params.pageNo = 1;
		params.pageSize = 10;
		params.filter = {};
		params.filter.customer_name = this.value;
		//params.filter.status = 1;
		var obj = $(this);
		$.ajax({
			  type : 'post', 
			  async: true,   
			  contentType : 'application/json',     
			  dataType : 'json',     
			  url : '../../customer/list',   
			  data:JSON.stringify(params),
			  success : function(data) {
				  if(data){
					  var customers = data.items;
					  if(customers.length>0){
						     $("#customerDataList").empty();
						     customerDataList = {};
					   }
					  $.each( customers, function(key,value){
						  var op = $("<option></option>");
						  op.val(obj.val()+" "+value.customer_name);
						  $("#customerDataList").append(op);
						  
						  customerDataList[value.customer_name]=value;
						});
				  }else{
					  $(document).sgPup({message:'message_info',text: data});
				  }
			  } ,     
			  error : function(res,error) { 
			  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
			  }    
			});
	};
	//填充最终客户
	$.ajax({
		  type : 'post', 
		  async: true,   
		  contentType : 'application/json',     
		  dataType : 'json',     
		  url : '../../customer/list',   
		  data:JSON.stringify({pageNo:1,pageSize:10,filter:{}}),
		  success : function(data) {
			  if(data){
				  var customers = data.items;
				  if(customers.length>0){
					     $("#customerDataList").empty();
					     customerDataList = {};
					  }
				  $.each( customers, function(key,value){
					  var op = $("<option></option>");
					  op.val(value.customer_name);
					  $("#customerDataList").append(op);
					  
					  customerDataList[value.customer_name]=value;
					});
				  
				  $("#customerName").on('keyup',checkCustomer);
				  $("#customerName").on('change',function(){
					    var strs = this.value.split(" ");
					    
					    if(customerDataList[strs[strs.length-1]]){
					    	$(this).val(strs[strs.length-1]);
							
							$("#customerId").val(customerDataList[strs[strs.length-1]].id);
							
							if($("#customerId").val().length==0){
								$("#customerName").val("");
							}
					    }else{
					    	$(this).val('');
					    	$("#customerId").val("");
					   }
					    
					});
				  
			  }else{
				  $(document).sgPup({message:'message_info',text: data});
			  }
		  } ,     
		  error : function(res,error) { 
		  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
		  }    
		});
	 //查询最终客户
    $('#acustomer').on('click',function(){
    	var isSure=false;
    	var getCusomer=function(){
    		var obj = $('#dgd_customer','#win_customer');
	        var bDiv = $('.bDiv',obj);
 	        if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length>1){
 	            $(document).sgPup({message:'message_info',text: "选择多于一个选项！"});
 	        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==0){
 	            $(document).sgPup({message:'message_info',text: "请选择一个选项！"});
 	        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==1){
 	        	  $('input[type=checkbox][checked=checked]',bDiv).each(function(){
 	 	                if($(this).attr("checked")){
 	 	                	isSure=true;
 	 	                	$(document).sgWindow('close',{id:'win_customer',beforeClose:winBefClose});
 	 	                }
 	        	  });
 	        }
	   };
    	 var winBefClose=function(){
    	    	//重新查询所属集团
    	    	//$("#groupName").trigger('keyup');
    	    	var isClose=true;
    	    	if(isSure){
    	    		var obj = $('#dgd_customer','#win_customer');
    		        var bDiv = $('.bDiv',obj);
    	 	        if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length>1){
    	 	            $(document).sgPup({message:'message_info',text: "选择多于一个选项！"});
    	 	            isClose=false;
    	 	        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==0){
    	 	            $(document).sgPup({message:'message_info',text: "请选择一个选项！"});
    	 	            isClose=false;
    	 	        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==1){
    	 	        	  $('input[type=checkbox][checked=checked]',bDiv).each(function(){
    	 	 	                if($(this).attr("checked")){ 
    	 	 	                   var rowData=$(this).data('data');
    	 	 	                   $('#customerName').val(rowData.customer_name);
    	 	 	                   $('#customerId').val(rowData.id);
    	 	 	                }
    	 	        	  });
    	 	        }
    	    	}
    	    	return isClose;
    	  };
    	  var winClose = function (){
              $(document).sgWindow('close',{id:'win_customer'});
           }
           
    	 var defaults = {
	                title:'客户信息',
	                id:'win_customer',
	                form:'win_customer',
	                url:'customer_form.html',
	                width: 788,
	                height: 452,
           	    	beforeClose:winBefClose,
           	    	buttons : [
	                           {name: '确定', type: 'button', onpress : getCusomer},
	                           {name: '关闭', onpress : winClose}
	                       ]
	            };
	        $(document).sgWindow(defaults);
    });
  
	//自动查询经办人
	var checkUser = function(){
		/* var text=this.value;
		text = text.replace(/\s/g,''); //去除空格
		if(text!=this.value){//有空格
			this.value=text;
			$(this).trigger('change');
			return false;
		} */
		var params = {};
		params.pageNo = 1;
		params.pageSize = 10;
		params.filter = {};
		params.filter.opname = this.value;
		params.filter.isCompany = true;//查询机构下的的所有操作人
		var obj = $(this);
		$.ajax({
			  type : 'post', 
			  async: true,   
			  contentType : 'application/json',     
			  dataType : 'json',     
			  url : '../../getOrgOperators',   
			  data:JSON.stringify(params),
			  success : function(data) {
				  if(data){
					  var manager = $("#managersName","#form_stockout_upgrade");
					  						  
					  if(manager){
						  if(data.items.length>0){
							  userDataList = {};
							  $("#userDataList").empty();
						  }
						  $.each(data.items,function(k,v){
							  var op = $("<option></option>");
							  op.val(obj.val()+" "+v.opname);
							  $("#userDataList").append(op);
							  
							  userDataList[v.opname] = v.opid;
	 				  	 }); 
						}
				  }else{
				  	$(document).sgPup({message:'message_info',text: data});
				  }
			  } ,     
			  error : function(res,error) { 
			  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
			  }    
			});
	}
	
  //填充经办人
    $.ajax( {
	  type : 'post', 
	  async: false,   
	  contentType : 'application/json',     
	  dataType : 'json',     
	  url : '../../getOrgOperators',   
	  data:JSON.stringify({pageNo:1,pageSize:10,filter:{isCompany:true}}),
	  success : function(data) {
		  if(data){
			  var manager = $("#managersName","#form_stockout_upgrade");
			  if(manager){
				  if(data.items.length>0){
			  		  userDataList = {};
					  $("#userDataList").empty();
				  }
				  $.each(data.items,function(k,v){
					  var op = $("<option></option>");
					  op.val(v.opname);
					  $("#userDataList").append(op);
					  
					  userDataList[v.opname] = v.opid;
				  	 }); 
				  manager.on('keyup',checkUser);
				  manager.on('change',function(){
					  	var strs = this.value.split(" ");
						$(this).val(strs[strs.length-1]);
						$("#managersId","#form_stockout_upgrade").val(userDataList[strs[strs.length-1]]);
						if($("#managersId","#form_stockout_upgrade").val().length==0){
							$("#managersName","#form_stockout_upgrade").val("");
							$('#borrowedNum').text('');
						}else{
							//根据经办人，获得他借用的商品总数量
							$.ajax({
								  type : 'POST', 
								  async: false,   
								  url : '../../stock/getBorrowTotalNum',  
								  data: {borrowerId:$("#managersId").val()},
								  success : function(data) {
									  if(data){
										 $('#borrowedNum').text("("+data+")");
									  }else{
										  $('#borrowedNum').text('(0)'); 
									  }
								  } 
							});
						}
					});

				};
		  }else{
		  	$(document).sgPup({message:'message_info',text: data});
		  }
	  },     
	  error : function(res,error) { 
	  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
	  }    
	});
  //填充商品
	$.ajax({
		  type : 'post', 
		  async: true,   
		  contentType : 'application/json',     
		  dataType : 'json',     
		  url : '../../product/findProducts',   
		  data:JSON.stringify({pageNo:1,pageSize:15,filter:{type:0}}),
		  success : function(data) {
			  if(data){
				  var products = data.items;
				  $("#productDataList").empty();
				  var key=null;
				  productDataList=[];
				  $.each( products, function(key,value){
					  var op = $("<option></option>");
					  key=value.code;
					  op.val(value.name.replace(/\s/g,'')+" "+value.code+" "+value.norm.replace(/\s/g,'-'));
					  
					  $("#productDataList").append(op);
					  productDataList[key]=value.id;
				 });

			  }else{
				  $(document).sgPup({message:'message_info',text: data});
			  }
		  } ,     
		  error : function(res,error) { 
		  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
		  }    
		});
	
	//自动查询商品
	var checkProduct = function(){
		/* var text=this.value;
		text = text.replace(/\s/g,''); //去除空格 
		if(text!=this.value){//有空格
			this.value=text;
			$(this).trigger('change');
			return false;
		} */
		var params = {};
		params.pageNo = 1;
		params.pageSize = 15;
		params.filter = {};
		params.filter.nameOrCode = this.value;
		var obj = $(this);
		$.ajax({
			  type : 'post', 
			  async: true,   
			  contentType : 'application/json',     
			  dataType : 'json',     
			  url : '../../product/findProducts',   
			  data:JSON.stringify(params),
			  success : function(data) {
				  if(data){
					  var products = data.items;
					  if(products.length>0){
						  $("#productDataList").empty();
					  productDataList=[];
					  }
					  var key=null;
					  $.each( products, function(key,value){
						  var op = $("<option></option>");
						  key=value.code;
						  op.val(obj.val()+" "+value.name.replace(/\s/g,'')+" "+value.code+" "+value.norm.replace(/\s/g,'-'));
							 
						  $("#productDataList").append(op);
						  productDataList[key]=value.id;
					 });
				  }else{
					  $(document).sgPup({message:'message_info',text: data});
				  }
			  } ,     
			  error : function(res,error) { 
			  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
			  }    
			});
	};
	$("#stockout_detail_panel input[list^=productDataList]").on('keyup',checkProduct);
	
	//添加商品、数量按钮点击
	$("#div_stockout_detail a").on('click',function(){
		var detail_div = $("<div></div>");
		var detail_id = "div_stockout_detail_"+flag;
		detail_div.attr('id',detail_id);
		detail_div.addClass("panel");
		detail_div.append($("#div_stockout_detail").html());
		
		$("#div_stockout_detail").before(detail_div);
		$("#"+detail_id+" img").attr('src','../../images/form_del.png');
		$("#"+detail_id+" img").attr('title','删除明细');
		$("#"+detail_id+" input[name=productName]").on('change',function(){
			var strs = this.value.split(" ");
			$(this).val(strs[strs.length-3]);
			if($(this).val()){
				//设置productId
				$(this).siblings('input[name=productId]').val(productDataList[strs[strs.length-2]]);
				//设置商品编码productCode
				$(this).siblings('input[name=productCode]').val(strs[strs.length-2]);
				//设置商品规格
	        	$(this).siblings('input[name=norm]').val(strs[strs.length-1]);
	        	var $this=$(this);
	        	//设置价格
				 $.ajax( {
					  type : 'post', 
					  async: false,   
					  dataType : 'json',     
					  url : '../../sell/getSalePriceByProductId',   
					  data:{productId:$(this).siblings('input[name=productId]').val(),channelId:null},
					  success : function(data) {
						  if(data){
							//设置商品价格
					       $this.siblings('input[name=price]').val(data.price);
					       $this.siblings('input[name=contractId]').val(data.contractId);
					     //设置费用
					        $this.siblings('input[name=num]').trigger('change');
						  }else{
							  $(document).sgPup({message:'message_info',text: data});
						  }
					  } ,     
					  error : function(res,error) { 
					  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
					  }    
					}); 
	        	//光标自动定到下一个可输入框
	        	$(this).nextAll('input[type=number]:enabled').focus();
			}else{
				//设置productId
				$(this).siblings('input[name=productId]').val('');
				//设置商品编码productCode
				$(this).siblings('input[name=productCode]').val('');
				//设置商品规格
	        	$(this).siblings('input[name=norm]').val('');
			}
		});
		
		//数量改变，费用跟着改变
		$("#"+detail_id+" input[name=num]").on('change',function(){
			var num=this.value;
			var price=$(this).siblings('input[name=price]').val();
			if(num && price){
				$(this).siblings('input[name=money]').val(Number(num)*Number(price));
				$(this).siblings('input[name=money]').trigger('change');
			}
		});
		//商品费用改变，总费用改变
		$("#"+detail_id+" input[name=money]").on('change',function(){
			var moneys=$('input[name=money]','#form_stockout_upgrade');
			var moneyTotal=0;
			 $.each(moneys,function(k,v){
				 moneyTotal=moneyTotal+Number(v.value);
			 });
			 $('#peopleMoney','#form_stockout_upgrade').val(moneyTotal);
		});
		$("#"+detail_id+" a").on('click',function(){
			$("#"+detail_id).remove();
		})
		$("#"+detail_id + " input[list=productDataList]").on('keyup',checkProduct);
		flag=flag+1;
	});
	
	$("#stockout_detail_panel input[name^=productName]").on('change',function(){
		var strs = this.value.split(" ");
		var $this=$(this);
		$this.val(strs[strs.length-3]);
		if($this.val()){
			//设置productId
			$this.siblings('input[name^=productId]').val(productDataList[strs[strs.length-2]]);
			//如果输入的是成品,要查询配件
			if($this.attr('name')=='productName1'){
				var productId1=$this.siblings('input[name^=productId]').val();
				 //配件信息窗口加载成功后
			    var partWinLoad = function(){
			    	if($('#dgd_part').get(0)){
			        	var query={productId:productId1};//type:1,如果是配件转成了成品，则查询配件时，把type=1的条件去掉 
			        	$('#dgd_part','#win_product_part').sgDatagrid('reload',{query:query,url:'../../product/findParts'});
			    	}
			 	}
			    var getParts=function(){
			    	var obj = $('#dgd_part','#win_product_part');
			        var bDiv = $('.bDiv',obj);
			        if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==0){
		 	            $(document).sgPup({message:'message_info',text: "请选择一个选项！"});
		 	        } else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length>0){
		 	        	  $('input[type=checkbox][checked=checked]',bDiv).each(function(){
		 	 	                if($(this).attr("checked")){ 
		 	 	                   var rowData=$(this).data('data');
		 	 	                   //加到出库列表
									  var divId='#div_stockout_detail';
									  var div_stockout_detail_len= $("div[id^=div_stockout_detail_]").length;
									  var productId0=$('input[name=productId]',divId).val();
									  if(div_stockout_detail_len==0 && !productId0){
										  divId='#div_stockout_detail';
									  }else{
										  $('#div_stockout_detail a').trigger('click');
										  var fflag=flag-1;
										  divId="#div_stockout_detail_"+fflag;
									  }
									 $('input[name=productName]',divId).val(rowData.name.replace(/\s/g,''));
									 $('input[name=productCode]',divId).val(rowData.code.replace(/\s/g,''));
									 $('input[name=productId]',divId).val(rowData.id);
									 $('input[name=norm]',divId).val(rowData.norm.replace(/\s/g,'-'));
									 $('input[name=num]',divId).val(rowData.num);
									 $('input[name=remark]',divId).val(rowData.remark);
									//设置价格
									 $.ajax( {
										  type : 'post', 
										  async: false,   
										  dataType : 'json',     
										  url : '../../sell/getSalePriceByProductId',   
										  data:{productId: $('input[name=productId]',divId).val(),channelId:$("#channelId",'#form_stockout_agent').val()},
										  success : function(data) {
											  if(data){
												//设置商品价格
										       $('input[name=price]',divId).val(data.price);
										       $('input[name=contractId]',divId).val(data.contractId);
											  }else{
												  $(document).sgPup({message:'message_info',text: data});
											  }
										  } ,     
										  error : function(res,error) { 
										  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
										  }    
										}); 
									//光标自动定到下一个可输入框
						        	$('input:enabled:last',divId).focus();
		 	 	                }
		 	        	  });
	              	$(document).sgWindow('close',{id:'win_product_part'});
		 	        }
	    	   };
			    //查询成品的配件信息
		    	//打开窗口
		         var defaults = {
			                title:'配件信息',
			                id:'win_product_part',
			                url:'../sel/product_part.html',
			                success: partWinLoad,
			                width: 828,
			                 height: 445,
			                buttons : [
										{name: '确定', type: 'button', onpress :getParts},
			                           {name: '关闭', type: 'button', onpress : function (){
			                               $(document).sgWindow('close',{id:'win_product_part'});
			                            }
			                           }
			                       ]
			            };
			        $(document).sgWindow(defaults);
		        
			}else{ //下面的商品列表
				//设置商品编码productCode
				$this.siblings('input[name=productCode]').val(strs[strs.length-2]);
				//设置商品规格
	        	$this.siblings('input[name=norm]').val(strs[strs.length-1]);
	        	//设置价格
				 $.ajax( {
					  type : 'post', 
					  async: false,   
					  dataType : 'json',     
					  url : '../../sell/getSalePriceByProductId',   
					  data:{productId:$this.siblings('input[name=productId]').val(),channelId:null},
					  success : function(data) {
						  if(data){
							//设置商品价格
					       $this.siblings('input[name=price]').val(data.price);
					       $this.siblings('input[name=contractId]').val(data.contractId);
					     //设置费用
					        $this.siblings('input[name=num]').trigger('change');
						  }else{
							  $(document).sgPup({message:'message_info',text: data});
						  }
					  } ,     
					  error : function(res,error) { 
					  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
					  }    
					}); 
	        	//光标自动定到下一个可输入框
	        	$this.nextAll('input[type=number]:enabled').focus();
			}
		}else{
			//设置productId
			$this.siblings('input[name=productId]').val('');
			//设置商品编码productCode
			$this.siblings('input[name=productCode]').val('');
			//设置商品规格
        	$this.siblings('input[name=norm]').val('');
		}
	});
	
	//数量改变，费用跟着改变
	$("#div_stockout_detail input[name=num]").on('change',function(){
		var num=this.value;
		var price=$(this).siblings('input[name=price]').val();
		if(num && price){
			$(this).siblings('input[name=money]').val(Number(num)*Number(price));
			$(this).siblings('input[name=money]').trigger('change');
		}
	});
	
	//商品费用改变，总费用改变
	$("#div_stockout_detail input[name=money]").on('change',function(){
		var moneys=$('input[name=money]','#form_stockout_upgrade');
		var moneyTotal=0;
		 $.each(moneys,function(k,v){
			 moneyTotal=moneyTotal+Number(v.value);
		 });
		 $('#peopleMoney','#form_stockout_upgrade').val(moneyTotal);
	});
	//提交按钮
	$('button[type=submit]').on('click',function(){
		var $this=this;
		//做表单提交
		var existProductMap=[];//已选择的商品
		//做表单提交
        var params = {};
        params.type = 0;
        params.code = $('#code','#form_stockout_upgrade').val();
        params.stamp= $('#stamp','#form_stockout_upgrade').val();
        params.managersId = $("#managersId",'#form_stockout_upgrade').val();	
        params.managersName = $("#managersName",'#form_stockout_upgrade').val();
        var customerName=$("#customerName",'#form_stockout_upgrade').val();
        if(customerName){
        	params.customerId=$("#customerId",'#form_stockout_upgrade').val();
        }
        params.receiptNo= $('#receiptNo','#form_stockout_upgrade').val();
	 	params.money= $('#peopleMoney','#form_stockout_upgrade').val();
 	    params.remark= $('#remark','#form_stockout_upgrade').val();
 	    params.type=2;
 	   
 	   var productIds = $('input[name=productId]','#stockout_detail_panel');
 	  var productCodes=$('input[name=productCode]','#stockout_detail_panel');
       var productNames=$('input[name=productName]','#stockout_detail_panel');
	    var productNorms=$('input[name=norm]','#stockout_detail_panel');
        var productNums= $('input[name=num]','#stockout_detail_panel');
        var contractIds= $('input[name=contractId]','#stockout_detail_panel');
        var prices= $('input[name=price]','#stockout_detail_panel');
        var moneys= $('input[name=money]','#stockout_detail_panel');
        var remarks= $('input[name=remark]','#stockout_detail_panel');
        var details = new Array();
        if(productNames.length==0){ 
     	   $(document).sgPup({message:'message_info',text: '请添加商品！'})
     	   return false;
        }
        $.each(productIds,function(k,v){
	       	var obj = {};
	       	obj.productId =v.value;
	       	obj.productName = productNames[k].value;
	       	obj.outNum = productNums[k].value;
	       	obj.outNum = productNums[k].value;
	       	obj.contractId = contractIds[k].value;
	    	obj.price = prices[k].value;
	       	obj.money = moneys[k].value;
	       	obj.remark = remarks[k].value;
	       	details.push(obj);
	    	if(v.value){
	       		productNames[k].setCustomValidity(''); 
		       	if(existProductMap[productIds[k].value]){ 
		        	productNames[k].setCustomValidity('此商品已添加!'); 
		       	   	return false;
		          }else{
		        	  productNames[k].setCustomValidity(''); 
		          	  existProductMap[productIds[k].value]=productIds[k].value;
		          }
		    }else{
		    	productNames[k].setCustomValidity('请输入商品名称/编码!'); 
		    }
	       });
        params.stockoutDetails = details;
        //是否立即核销
        if($('#chk_writeoff_now','#form_stockout_upgrade').get(0).checked){
        	params.isWriteoffNow=true;
        }else{
        	params.isWriteoffNow=false;
        }
        
        $('form:eq(0)').unbind('submit');//以下两行可以阻止提交2次，暂时注释，也不会提交2次
		
	    $("#form_stockout_upgrade").on('submit',function(e){
	        //alert(JSON.stringify(params));
	        $(document).sgConfirm({text: '确定进行升级出库吗?',cfn:function(r){ 
		     if(r){
	     
		        $.ajax( {
				  type : 'post', 
				  async: false,   
				  contentType : 'application/json',     
				  dataType : 'json',     
				  url : '../../stock/addStockOut',   
				  data:JSON.stringify(params),
				  success : function(data) {
					  if(data){
					  	 $(document).sgPup({message:'message_info',text: data.msg,cfn:function(){
   	       				
						  if(data.success){
							  
							/* //如果是立即核销，跳到核销页面
								if($('#chk_writeoff_now','#form_stockout_upgrade').get(0).checked){
									var writeoffData={};
									writeoffData.managersId=params.managersId;
									writeoffData.managersName=params.managersName;
									if(data.stockoutDetailsIds){
										writeoffData.stockoutDetailsIds=data.stockoutDetailsIds;
									}
								   //保存缓存数据，到核销页面去取得
								   $('#whs_menu').data('writeoffData',writeoffData);
							    } */
							
							  //$('#ifm_print').attr('src','stock_print2.html');
							  //如果是“提交并打印”按钮，需要打印
 								if($($this).text()=='提交并打印'){
 									var	sName='winPrint';
 									var isChrome = navigator.userAgent.toLowerCase().match(/chrome/) != null;
 									if (isChrome){
 									  sName='ifm_print';
 									}
 									window.open('print.html',sName,'height='+$(window).outerHeight()+',width='+$(window).outerWidth()+',top=0,left=0,toolbar=no,menubar=no,scrollbars=no,resizable=no,location=no,status=no,alwaysRaised=yes');
 									if (!isChrome){
 										//新增遮罩层
 						  				var mask=$('<div id="print_mask"></div>');
 						  				mask.addClass('window-mask');
 						  				mask.css('z-index',Number($('div.window').css('z-index'))+1);//如果有弹出窗口，则将遮罩层置为最上层
 						  		        var span=$('<span></span');
 						  		        span.css({position:'absolute',left:$(window).outerWidth()/2,top:$(window).outerHeight()/2-60,color:'red','font-size':'x-large','font-weight':'bold'});
 						  		        span.text('正在打印中...');
 						  		        mask.append(span);
 						  			    $(window.document.body).append(mask);
 									}
 								}
						  }
						}});
						//$(document).sgPup({message:'message_info',text: data.msg});
						 if(data.code){//自动生成单号
							  $('#code').val(data.code);
						  }
					  }else{
						  $(document).sgPup({message:'message_info',text: data});
					  }
				  } ,     
				  error : function(res,error) { 
				  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
				  }    
				}); 
	         } 
	     }});
	      //$('#form_stockout_upgrade').unbind('submit');//以下两行可以阻止提交2次，暂时注释，也不会提交2次
	  	  // e.stopPropagation();
	  	   return false;
	   });
	});
	
	 //打印
	$('#btn_print').on('click',function(){
		$('#ifm_print').attr('src','stock_print2.html');
		//window.open("web/whs/stock_print2.html","stock_print","width=870,toolbar=no,menubar=no,scrollbars=no,resizable=no,location=no,status=no");  
	});
	 
	 //重置
	$("#mycancel").on('click',function(e){
		 reset();
	 })
	 
	//回车事件代替tab键
	$(window.document).keydown(function(event){
        switch(event.keyCode) {
            case 13:
                event.keyCode=9;
                break;
        }
    });
})(jQuery)

//重置
var reset = function(){
    $("#form_stockout_upgrade").get(0).reset();
  //删除多行商品，只留下最后一行
	$('#div_stockout_detail').prevAll('div[id^=div_stockout_detail]').find('a').trigger('click');
	$('#borrowedNum').text('');  
  //填充出库单号
 	$.ajax({
 		  type : 'POST', 
 		  async: false,   
 		  url : '../../stock/getStockInOutNo',
 		  dataType : 'json',    
 		  data: {isIn:false},
 		  success : function(data) {
 			  if(data){
 				  if(data.success){
 					  $('input,select,textarea,a,button').removeAttr('disabled');
 				  	  $("#code").val(data.code);
 				  	 //入库日期
 				      $("#stamp").val(new Date().format('yyyy-MM-dd'));	
 				  	 //出库单号、日期、规格重新设置disabled
 				      $('#code,#stamp,input[name=norm]').attr('disabled',true);
 				  }else{
 					  if(data.msg&&data.msg.indexOf('仓库正在盘点')>-1){
 						$('input,select,textarea,a,button').attr('disabled',true);
 					  }
 					 $(document).sgPup({message:'message_info',text: data.msg,cfn:function(){
 						$('input,select,textarea,a,button').attr('disabled',true);
 					}}); 
 				  }
 			  }
 		  } 
 	});
};

//打印页面元素设置
  var callback=function(subWinBody,subWin){
	 var wareHouseName=null;//仓库名称
		//得到仓库名称
	         $.ajax({
			  type : 'POST', 
			  async: false,   
			  url : '../../stock/getWarehouseName', 
			  dataType : 'json',  
			  data:{},
			  success : function(data) {
				  if(data){
					wareHouseName=data.name;
				  }else{
					wareHouseName='&nbsp;';
				  }
			  } ,     
			  error : function(res,error) { 
			  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
			  }   
			  
		    });
	$.ajax( {
		  type : 'post', 
		  async: false,   
		  contentType : 'application/json',     
		  dataType : 'json',     
		  url : '../../getCurrentCompany',   
		  data:JSON.stringify({}),
		  success : function(data) {
			  if(data){
				  var total = 0;
				  var money = 0;
				  //公司中文名字
				  $("#cname",subWinBody).empty();
				  $("#cname",subWinBody).append(data.cnfullname);
				  //公司英文名字
				  $("#ename",subWinBody).empty();
				  $("#ename",subWinBody).append(data.enfullname);
				  //表单名字
				  $("#orderTitle",subWinBody).empty();
				  $("#orderTitle",subWinBody).append("升级出库单");
				  //表单日期
				  $("#orderDate",subWinBody).empty();
				  $("#orderDate",subWinBody).append($("#stamp").val());
				  //表单单号
				  $("#orderNo",subWinBody).empty();
				  $("#orderNo",subWinBody).append($("#code").val());
				  
				  //表前输入单
				 //表前输入单
				  var outWhs = '<span style="width:10%;">出库仓库：</span>';
				  outWhs =outWhs+'<div style="width:23%;">'+wareHouseName+'</div>';
				 
				  $("#headInput",subWinBody).append(outWhs);
				  
				  var managers = '<span style="width:10%;">经办人：</span>';
				  managers =managers+'<div style="width:23%;">'+$("#managersName").val()+'</div>';
				  $("#headInput",subWinBody).append(managers);
				  
				  var receiptNo = '<span style="width:10%;">收据票号：</span>';
				  receiptNo =receiptNo+'<div style="width:23%;">'+$("#receiptNo").val()+'</div>';
				  $("#headInput",subWinBody).append(receiptNo);
				  
				  var peopleMoney = '<span style="width:10%;">费用：</span>';
				  peopleMoney =peopleMoney+'<div style="width:23%;">'+$("#peopleMoney").val()+'</div>';
				  $("#headInput",subWinBody).append(peopleMoney);
				  
				  //表头
				  $("#tbHead",subWinBody).append('<td style="width: 10%;">序号</td>'+
														  '<td style="width: 15%;">商品编码</td>'+
														  '<td style="width: 15%;">商品名称</td>'+
														  '<td style="width: 20%;" >商品规格</td>'+
														  '<td style="width: 5%;">数量</td>'+
														  '<td style="width: 10%;">费用</td>'+
														  '<td style="width: 15%;">备注</td>');
				  
				  //表格主体
				  var productIds = $('input[name=productId]','#form_stockout_upgrade');
				  var productCodes=$('input[name=productCode]','#form_stockout_upgrade');
	              var productNames=$('input[name=productName]','#form_stockout_upgrade');
	              var norms = $('input[name=norm]','#form_stockout_upgrade');
	              var productNums= $('input[name=num]','#form_stockout_upgrade');
	              var moneys= $('input[name=money]','#form_stockout_upgrade');
	              var remarks= $('input[name=remark]','#form_stockout_upgrade');
	              $.each(productIds,function(k,v){
	            	var tbbody_tr ='<tr>';
		               	
	               	var tbbody_td1 = '<td>'+(k+1)+'</td>';
	               	tbbody_tr=tbbody_tr+tbbody_td1;
	               	
	               	var tbbody_td2 = '<td>'+productCodes[k].value+'</td>';
	               	tbbody_tr=tbbody_tr+tbbody_td2;
	               	
	               	var tbbody_td3 = '<td>'+productNames[k].value+'</td>';
	               	tbbody_tr=tbbody_tr+tbbody_td3;
	               	
	               	var tbbody_td4 = '<td>'+norms[k].value+'</td>';
	               	tbbody_tr=tbbody_tr+tbbody_td4;
	               	
	               	var tbbody_td5 = '<td>'+productNums[k].value+'</td>';
	               	tbbody_tr=tbbody_tr+tbbody_td5;
	               	total=Number(total)+Number(productNums[k].value);
	               	
	          /*      	var tbbody_td_price ='<td width="100px;">'+prices[k].value+'</td>';
	               	//money=Number(money)+Number(prices[k].value);
	               	money=Number(money)+(Number(prices[k].value)*Number(productNums[k].value));
	               	tbbody_tr=tbbody_tr+tbbody_td_price; */
	               	var tbbody_td_money = '<td>'+moneys[k].value+'</td>';
	               	tbbody_tr=tbbody_tr+tbbody_td_money; 
	               	
	               	var tbbody_td6 = '<td>'+remarks[k].value+'</td>';
	               	tbbody_tr=tbbody_tr+tbbody_td6;
	               	
	               	tbbody_tr=tbbody_tr+'</tr>';

	               	$("#tbBody",subWinBody).append(tbbody_tr);
	              })
				    //表合计
				  var tbfoot = '<tr>';
				  tbfoot=tbfoot+'<td colspan="4"><div style="text-align:right">小计:</div></td>';
				  tbfoot=tbfoot+'<td colspan="1">'+total+'</td>';
				  //tbfoot=tbfoot+'<td colspan="1">'+money.toFixed(2)+'</td>';
				  tbfoot=tbfoot+'<td colspan="2"></td>';
				  tbfoot=tbfoot+'</tr>';
	               
				  $("#tbBody",subWinBody).append(tbfoot);
	             /*  //表合计
				  var tbfoot = '<tr>';
				  
				  var tbfoot_td1 ='<td width="428px"><div style="text-align:right">小计:</div></td>';
				  tbfoot=tbfoot+tbfoot_td1;
				  
				  var tbfoot_td2 = '<td width="349px"><div style="text-align:right;padding-right:76px;">'+total+'</div></td>';
				  tbfoot=tbfoot+tbfoot_td2;
				  
				  tbfoot=tbfoot+'<td style="width: 289px"><div>&nbsp;</div></td></tr>';				  
				  $("#tbFoot",subWinBody).append(tbfoot); */
				  //表尾输入单
				  $("#foot",subWinBody).append('<span>核准人：</span><div>&nbsp;</div>'+
													  '<span>复核人：</span><div>&nbsp;</div>'+
													  '<span>仓管员：</span><div>&nbsp;</div>'+
													  '<span>制单：</span><div>&nbsp;</div>');
				  
			  }else{
				  $(document).sgPup({message:'message_info',text: data});
			  }
		  } ,     
		  error : function(res,error) { 
		  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
		  }    
		});
	
    if (navigator.appName == 'Microsoft Internet Explorer'){
    	subWin.print();  
    }else{ 
    	subWin.focus();
    	subWin.print();  
    }
  //打印后，再重置出库页面上的参数
    reset();
   /*  //如果是立即核销，跳到核销页面
	if($('#chk_writeoff_now','#form_stockout_upgrade').get(0).checked){
	   //保存缓存数据，到核销页面去取得
       $('#whs_menu ul li img[alt=核销]').parents('a').trigger('click');
    } */
}
</script>
</html>