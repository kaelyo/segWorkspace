<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="UTF-8">
</head>
<body>
    <div id="dispatchgrid" class="datagrid"></div>
</body>

<script type="text/javascript">
(function($){
	
	
	var loadSuccessfollow = function(){
 		//填充编辑前的值
 		   if(editId && editObj){
 				  $("#taskId",$("#follow")).val(editObj.id);
				  $("#customer",$("#follow")).val(editObj.customerName);
				  $("#dispatch_id",$("#follow")).val(editObj.dispatchId);
				  if(editObj.status == 5){
					   $("[name = is_over]:checkbox",$("#follow")).attr("checked", true);
				  }
					 var company =  $("#company",$("#follow"));
					 $.ajax({
						  type : 'post', 
						  async: true,   
						  url : 'dispatchElectrician/getElectriciansBytaskId',   
						  data:{id:$("#taskId").val()},
						  success : function(data) {
							  if(data){
								  
								  $.each(data,function(k,v){
								  	  company.append("<option value='" +v.id+"'>" + v.name+"</option>");
								  });
							  }else{
							  	alert(data);
							  }
						  } ,     
						  error : function(res,error) { 
						  	     if(res && res.responseText){ alert(res.responseText);}     
						  }    
						});
					 
 		   }
 		  editId=null;
 		 editObj=null; 
 		  
 	   }

 
    
	var loadSuccess11 = function(){
 		//填充编辑前的值
 		   if(editId && editObj){
 				  $("#taskId",$("#dispatch_newclothes")).val(editObj.id);
				  $("#billnum",$("#dispatch_newclothes")).val(editObj.billnum);
				  $("#managerName",$("#dispatch_newclothes")).val(editObj.managerName);
				  $("#customerName",$("#dispatch_newclothes")).val(editObj.customerName);
				  $("#product_name",$("#dispatch_newclothes")).val(editObj.productName);
				  $("#cartype_name",$("#dispatch_newclothes")).val(editObj.cName);
				  $("#place",$("#dispatch_newclothes")).val(editObj.place);
				  $("#phone",$("#dispatch_newclothes")).val(editObj.phone);
				  $("#requirements",$("#dispatch_newclothes")).val(editObj.requirements);
				  if(editObj.isoffice == 1){
					   $("[name = is_busines]:checkbox",$("#dispatch_newclothes")).attr("checked", true);
				  }
				  $.ajax( {
					  type : 'POST', 
					  async: true,  
					  url : "customer/getCustomerPhone",   
					  data:{id:editObj.customerId},
					  success : function(data) {
						  if(data){
							  $("#phone","#dispatch_newclothes").val(data);
						  }
					  } 
				});
				  
				  $.ajax( {
					  type : 'POST', 
					  async: true,  
					  url : "reservation/getReservationMsg",   
					  data:{id:editObj.id},
					  success : function(data) {
						  if(data){
							  $("#time","#dispatch_newclothes").val(data.time);
							  $("#reservation_id","#dispatch_newclothes").val(data.rid);
						  }
					  } 
				});
				  
				  
 		   }
 		  editId=null;
 		 editObj=null; 
 		  
 	   }
    
	
	var loadSuccess12 = function(){
 		//填充编辑前的值
 		   if(editId && editObj){
 				  $("#taskId",$("#dispatch_repair")).val(editObj.id);
				  $("#billnum",$("#dispatch_repair")).val(editObj.billnum);
				  $("#type",$("#dispatch_repair")).val(editObj.type); 
				  
				  $("#car_num",$("#dispatch_repair")).val(editObj.carNum);
				  $("#code",$("#dispatch_repair")).val(editObj.code);
				  $("#cartype_name",$("#dispatch_repair")).val(editObj.cName);
				  $("#place",$("#dispatch_repair")).val(editObj.place);
				  $("#symptom",$("#dispatch_repair")).val(editObj.customerName);
				  $("#note",$("#dispatch_repair")).val(editObj.note);
				  $("#customerName",$("#dispatch_repair")).val(editObj.customerName);
				  if(editObj.isoffice == 1){
					   $("[name = is_busines]:checkbox",$("#dispatch_repair")).attr("checked", true);
				  }
				  
				  $.ajax( {
					  type : 'POST', 
					  async: true,  
					  url : "reservation/getReservationMsg",   
					  data:{id:editObj.id},
					  success : function(data) {
						  if(data){
							  $("#time","#dispatch_repair").val(data.time);
							  $("#reservation_id","#dispatch_repair").val(data.rid);
						  }
					  } 
				});
				  
				  
 		   }
 		  editId=null;
 		 editObj=null; 
 		  
 	   }
    
	
	
	var loadSuccess13 = function(){
 		//填充编辑前的值
 		   if(editId && editObj){
 				  $("#taskId",$("#dispathch_police")).val(editObj.id);
				  $("#billnum",$("#dispathch_police")).val(editObj.billnum);
				  $("#customerName",$("#dispathch_police")).val(editObj.customerName);
				  
				  $("#code",$("#dispathch_police")).val(editObj.code);
				  $("#color",$("#dispathch_police")).val(editObj.color);
				  $("#type",$("#dispathch_police")).val(editObj.type);
				  $("#cartype_name",$("#dispathch_police")).val(editObj.cName);
				  $("#place",$("#dispathch_police")).val(editObj.place);
				  $("#note",$("#dispathch_police")).val(editObj.note);
				  if(editObj.isoffice == 1){
					   $("[name = is_busines]:checkbox",$("#dispathch_police")).attr("checked", true);
				  }
				  
				  $.ajax( {
					  type : 'POST', 
					  async: true,  
					  url : "reservation/getReservationMsg",   
					  data:{id:editObj.id},
					  success : function(data) {
						  if(data){
							  $("#time","#dispathch_police").val(data.time);
							  $("#reservation_id","#dispathch_police").val(data.rid);
						  }
					  } 
				});
				  
				  
 		   }
 		  editId=null;
 		 editObj=null; 
 		  
 	   }
    
	
	
	var loadSuccess14 = function(){
 		//填充编辑前的值
 		   if(editId && editObj){
 				  $("#taskId",$("#dispathch_other")).val(editObj.id);
				  $("#billnum",$("#dispathch_other")).val(editObj.billnum);
				  $("#customerName",$("#dispathch_other")).val(editObj.customerName);
				  $("#code",$("#dispathch_other")).val(editObj.code);
				  $("#car_num",$("#dispathch_other")).val(editObj.code);
				  $("#color",$("#dispathch_other")).val(editObj.color);
				  $("#cartype_name",$("#dispathch_other")).val(editObj.cName);
				  $("#place",$("#dispathch_other")).val(editObj.place);
				  $("#note",$("#dispathch_other")).val(editObj.note);
				  $("#phone",$("#dispathch_other")).val(editObj.phone);
				  if(editObj.isoffice == 1){
					   $("[name = is_busines]:checkbox",$("#dispathch_other")).attr("checked", true);
				  }
				  $.ajax( {
					  type : 'POST', 
					  async: true,  
					  url : "customer/getCustomerPhone",   
					  data:{id:editObj.customerId},
					  success : function(data) {
						  if(data){
							  $("#phone","#dispathch_other").val(data);
						  }
					  } 
				});
				  
				  $.ajax( {
					  type : 'POST', 
					  async: true,  
					  url : "reservation/getReservationMsg",   
					  data:{id:editObj.id},
					  success : function(data) {
						  if(data){
							  $("#time","#dispathch_other").val(data.time);
							  $("#reservation_id","#dispathch_other").val(data.rid);
						  }
					  } 
				});
				  
				  
 		   }
 		  editId=null;
 		 editObj=null; 
 		  
 	   }
    
	
    
	
	
	var loadSuccess = function(){
 		//填充编辑前的值
 		   if(editId && editObj){
				  $("#billnum",$("#view_task")).val(editObj.billnum);
				  $("#manager_name",$("#view_task")).val(editObj.managerName);
				  $("#customer_name",$("#view_task")).val(editObj.customerName);
				  //$("#product_name",$("#view_task")).val(editObj.productName);
				  $("#vehicle_type",$("#view_task")).val(editObj.cName);
				  $("#place",$("#view_task")).val(editObj.place);
				  $("#requirements",$("#view_task")).val(editObj.requirements);
				  if(editObj.isoffice == 1){
					   $("[name = isoffice]:checkbox",$("#view_task")).attr("checked", true);
				  }
				  $.ajax( {
					  type : 'POST', 
					  async: true,  
					  url : "customer/getCustomerPhone",   
					  data:{id:editObj.customerId},
					  success : function(data) {
						  if(data){
							  $("#phone","#view_task").val(data);
						  }
					  } 
				});
				  
				  
				  $.ajax({
						type : 'post',
						async : false,
						contentType : 'application/json',
						dataType : 'json',
						url : 'taskFlow/getDispatchers',
						data : JSON.stringify({
							id : editId
						}),
						success : function(data) {
							if (data) {
								var objs = document.getElementsByName("treeCheckbox");
								for(var i=0;i<objs.length;i++){
									var id = objs[i].id;
									if(data.indexOf(id)!=-1){
										objs[i].checked = true;
									}
								}
							}
						},
						error : function(res, error) {
							alert("responseText=" + res.responseText
									+ ";error=" + error);
						}
					});
				  
 		   }
 		  editId=null;
 		 editObj=null;
 		  
 	   }
	
	
 

    var followItem = function(){
        var obj = $('#dispatchgrid');
        var bDiv = $('.bDiv',obj);
        var title;
        //alert($('input[type=checkbox][checked=checked]',bDiv).length) ;
        if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length>1){
            alert("选择多于一个选项！");
        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==0){
            alert("请选择一个选项！");
        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==1){
            $('input[type=checkbox][checked=checked]',bDiv).each(function(){
            	title = $(this).data('data').billnum + "派工单跟单";
            	editId=this.value;
            	editObj=$(this).data('data');
            });
            var defaults = {
       			title : title,
       			id : 'follow',
       			form : 'follow_form',
       			url : 'web/bsp/followbill.html',
       			success: loadSuccessfollow,
       			width : 390,
       			height : 300,
       			buttons : [ {
       				name : '确认',
       				type : 'submit',
       				onpress : saveFollow
       			}, {
       				name : '取消',
       				onpress : winClose1
       			} ]
       		};
       		$(document).sgWindow(defaults);
        }else{
            alert("请选择一个选项！");
        }
    }
    
    var addanswerItem = function(){
        var obj = $('#dispatchgrid');
        var bDiv = $('.bDiv',obj);
        var url;
        var title;
        //alert($('input[type=checkbox][checked=checked]',bDiv).length) ;
        if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length>1){
            alert("选择多于一个选项！");
        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==0){
            alert("请选择一个选项！");
        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==1){
        	$('input[type=checkbox][checked=checked]',bDiv).each(function(){
        		var type = $(this).data('data').type;
        		if(type.indexOf('新装')!=-1){
        			url = 'web/bsp/answer/answer_newclothes.html';
        		}else if(type.indexOf('大客户安装')!=-1){
        			url = 'web/bsp/answer/answer_newclothes.html';
        		}else if(type.indexOf('大客户维修')!=-1){
        			url = 'web/bsp/answer/answer_repair.html';
        		}else if(type.indexOf('维修')!=-1){
        			url = 'web/bsp/answer/answer_repair.html';
        		}else if(type.indexOf('升级')!=-1){
        			url = 'web/bsp/answer/answer_upgrade.html';
        		}else if(type.indexOf('换装')!=-1){
        			url = 'web/bsp/answer/answer_repair.html';
        		}
        		title = type+'回单';
        	});
        	var defaults = {
       			title : title,
       			id : 'answer',
       			form : 'answer_form',
       			url : url,
       			width : 710,
       			height : 420,
       			buttons : [ {
       				name : '保存',
       				onpress : winClose2
       			}, {
       				name : '关闭',
       				onpress : winClose2
       			} ]
       		};
       		$(document).sgWindow(defaults);
        }else{
            alert("请选择一个选项！");
        }
    }
    
    var winClose = function() {
		$(document).sgWindow('close', {
			id : 'dispathch'
		});
	}
    
    var winClose1 = function() {
		$(document).sgWindow('close', {
			id : 'follow'
		});
	}
    
    var winClose2 = function() {
		$(document).sgWindow('close', {
			id : 'answer'
		});
	}
    
    var winClose3 = function() {
		$(document).sgWindow('close', {
			id : 'bill_view'
		});
	}
    
    
    
    var viewItem = function() {
    	debugger;
    	 	var obj = $('#dispatchgrid');
	        var bDiv = $('.bDiv',obj);
	        if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length>1){
	            alert("选择多于一个选项！");
	        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==0){
	            alert("请选择一个选项！");
	        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==1){
	        	 $('input[type=checkbox][checked=checked]',bDiv).each(function(){
		                if($(this).attr("checked")){  
		                	editId=this.value;
		                	editObj=$(this).data('data');
			    			var defaults = {
			    				title : '工单查看调度',
			    				id : 'bill_view',
			    				form : 'bill_view_form',
			    				url : 'web/bsp/bill_view.html',
			    				success: loadSuccess,
			    				width : 710,
			    				height : 400,
			    				buttons : [ {
			    					name : '关闭',
			    					onpress : winClose3
			    				} ]
			    			};
			    			$(document).sgWindow(defaults);
		                }
		            });
	   }else{
	       alert("请选择一个选项！");
	    }
    	
	}
	 
	 var deleteItem = function(){
	        var obj = $('#dispatchgrid');
	        var bDiv = $('.bDiv',obj);

	        if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==0){
	            $(document).sgPup({message:'message_info',text: "请选择一个选项！"});
	        }else{
	        	if(window.confirm('确定该工单作废吗?')){
	        		var flag = false;
	        		$('input[type=checkbox][checked=checked]',bDiv).each(function(){
		                if($(this).attr("checked")){    
		                	editId=this.value;
		                	editobj = $(this).data('data');
		                		var ids=[];
		                		ids.push(editId);
			                	//打开窗口
			                	$.ajax( {
				            		  type : 'post', 
				            		  async: false,   
				            		  contentType : 'application/json',     
				            		  dataType : 'json',     
				            		  url : 'task/deleteTasks',   
				            		  data:JSON.stringify(ids),
				            		  success : function(data) {
				            			  if(data){
				            				 if(data.success){
				    	          		 		flag = true; 
				            				 }else{
				            					flag = false; 
				            				 }
				            			  }
				            		  } ,     
				            		  error : function(res,error) { 
				            		  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
				            		  }    
				            		}); 
		                	
		                }
		            });
	        		if(flag){
	        			$(document).sgPup({message:'message_info',text: "删除成功！"});
	        		}else{
	        			//$(document).sgPup({message:'message_info',text: "删除不成功！"});
	        		}
	        		$('#reservationgrid').sgDatagrid('reload','sgDatagrid');
	        	}	            
	        }
	    }
	 
	 
	 var endItem = function(){
	        var obj = $('#dispatchgrid');
	        var bDiv = $('.bDiv',obj);

	        if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==0){
	            $(document).sgPup({message:'message_info',text: "请选择一个选项！"});
	        }else{
	        	if(window.confirm('确定结束该工作单吗?')){
	        		var flag = false;
	        		$('input[type=checkbox][checked=checked]',bDiv).each(function(){
		                if($(this).attr("checked")){    
		                	editId=this.value;
		                	editobj = $(this).data('data');
		                		var ids=[];
		                		ids.push(editId);
			                	//打开窗口
			                	$.ajax( {
				            		  type : 'post', 
				            		  async: false,   
				            		  contentType : 'application/json',     
				            		  dataType : 'json',     
				            		  url : 'task/endTasks',   
				            		  data:JSON.stringify(ids),
				            		  success : function(data) {
				            			  if(data){
				            				 if(data.success){
				    	          		 		flag = true; 
				            				 }else{
				            					flag = false; 
				            				 }
				            			  }
				            		  } ,     
				            		  error : function(res,error) { 
				            		  	     if(res && res.responseText){ $(document).sgPup({message:'message_info',text: res.responseText});}     
				            		  }    
				            		}); 
		                	
		                }
		            });
	        		if(flag){
	        			$(document).sgPup({message:'message_info',text: "操作成功！"});
	        		}else{
	        			//$(document).sgPup({message:'message_info',text: "删除不成功！"});
	        		}
	        		$('#reservationgrid').sgDatagrid('reload','sgDatagrid');
	        	}	            
	        }
	    }
	 
	 
	 
    
    var dispatchItem = function(){
        var obj = $('#dispatchgrid');
        var bDiv = $('.bDiv',obj);
        var url;
        var title;
        var btype;
        var successVar;
        var saveVar;
        if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length>1){
            alert("选择多于一个选项！");
        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==0){
            alert("请选择一个选项！");
        }else if($('input[type=checkbox][checked=checked]',bDiv)!=null&&$('input[type=checkbox][checked=checked]',bDiv).length==1){
        	$('input[type=checkbox][checked=checked]',bDiv).each(function(){
	            editId=this.value;
	            editObj=$(this).data('data');
        		var type = $(this).data('data').billtype;
        		if(type==1){
        			url = 'web/bsp/dispathch/dispathch_newclothes.html';
        			btype = "新装";
        			successVar=loadSuccess11;
        			saveVar = save1;
        		}else if(type==2){
        			url = 'web/bsp/dispathch/dispathch_repair.html';
        			btype = "维修";
        			successVar=loadSuccess12;
        			saveVar = save2;
        		}else if(type==3){
        			url = 'web/bsp/dispathch/dispathch_police.html';
        			btype = "出警";
        			successVar=loadSuccess13;
        			saveVar = save3;
        		}else if(type==4){
        			url = 'web/bsp/dispathch/dispathch_other.html';
        			btype = "其他";
        			successVar=loadSuccess14;
        			saveVar = save4;
        			
        		}
        		title = btype+'派工单';
        	});
        	var defaults = {
       			title : title,
       			id : 'dispathch',
       			form : 'dispathch_form',
       			url : url,
       			success: successVar,
       			width : 710,
       			height : 460,
       			buttons : [
       			           
       			 {name: '保存', type: 'submit', onpress : saveVar},    
       			 {
       				name : '发送短信',
       				onpress : winClose
       			}, {
       				name : '打印',
       				onpress : winClose
       			} ]
       		};
       		$(document).sgWindow(defaults);
        }else{
            alert("请选择一个选项！");
        }
    }
    
    
    
    //跟单
    var saveFollow = function(){
    	//做表单提交
        var params = {};
    	var url='follow/add';
	 	params.task_id=$('#taskId','#follow').val();
	 	params.worker_id=$('#company','#follow').val();
		params.worker=$('#company','#follow').find("option:selected").text();
		params.arrival_time=$('#arrival_time','#follow').val();
		params.departure_time=$('#departure_time','#follow').val();
		params.dispatch_id=$('#dispatch_id','#follow').val();
		/* alert($('#is_over','#follow').get(0).checked); */
	    var chwckk_bu = document.getElementById("is_over");
      	if(chwckk_bu.checked){
      		params.is_end="1";
	    }else{
	    	params.is_end="0";
	    }
		params.remark=$('#remark','#follow').val();
		params.num=$('#num','#follow').val();
		 	alert(JSON.stringify(params));
		 if(window.confirm('确定保存跟单吗?')){
		 	 if(!params.arrival_time){
	      	 	  alert('请输入到达时间！');
	      	  	  return false;
       		 }
		 	if(!params.departure_time){
		       	   alert('请输入离开时间！');
		       	   return false;
        	 }
             $.ajax( {
           		  type : 'post', 
           		  async: false,   
           		  contentType : 'application/json',     
           		  dataType : 'json',     
           		  url : url,   
           		  data:JSON.stringify(params),
           		  success : function(data) {
           			  if(data){
           				 if(data.success){
           					 $('#dispatchgrid').sgDatagrid('reload','sgDatagrid');
           				 }
           				 alert(data.msg);
           			  }
           		  } ,     
           		  error : function(res,error) { 
           		  	 alert(res.responseText);     
           		  }    
           		}); 
		 	}
        $('#follow').unbind();//以下两行可以阻止提交2次，暂时注释，也不会提交2次
        $(document).sgWindow('close', {id : 'follow'});
    	return false;
 	   }; 

    var save1 = function(){
	    	//做表单提交
	        var params = {};
	    	var url='dispatchTask/add';
		 	params.task_id=$('#taskId','#dispatch_newclothes').val();
		 	params.reservation_id=$('#reservation_id','#dispatch_newclothes').val();
			params.electricianNames=$('#electrician','#dispatch_newclothes').val();
			params.electricianIds=$('#electricianIds','#dispatch_newclothes').val();
			params.electrician_phone=$('#electrician_phone','#dispatch_newclothes').val();
			params.start_time=$('#start_time','#dispatch_newclothes').val();
			params.duration=$('#duration','#dispatch_newclothes').val();
  		 	alert(JSON.stringify(params));
  		 	if(window.confirm('确定保存接单吗?')){
  		 	 if(!params.electricianIds){
          	   alert('请选择电工！');
          	   return false;
             }
  		 	 
  		 	if(!params.start_time){
           	   alert('请输入开始时间！');
           	   return false;
              }
  		 
  		 	if(!params.duration){
           	   alert('请输入预计时长！');
           	   return false;
              } 
  		 		
                 $.ajax( {
	           		  type : 'post', 
	           		  async: false,   
	           		  contentType : 'application/json',     
	           		  dataType : 'json',     
	           		  url : url,   
	           		  data:JSON.stringify(params),
	           		  success : function(data) {
	           			  if(data){
	           				 if(data.success){
	           					 $('#dispatchgrid').sgDatagrid('reload','sgDatagrid');
	           				 }
	           				 alert(data.msg);
	           			  }
	           		  } ,     
	           		  error : function(res,error) { 
	           		  	 alert(res.responseText);     
	           		  }    
	           		}); 
  		 	}
	        $('#dispatch_newclothes').unbind();//以下两行可以阻止提交2次，暂时注释，也不会提交2次
	        $(document).sgWindow('close', {id : 'dispathch'});
	    	return false;
	 	   }; 
    
    

	 	    var save2 = function(){
	 		    	//做表单提交
	 		        var params = {};
	 		    	var url='dispatchTask/add';
	 			 	params.task_id=$('#taskId','#dispatch_repair').val();
	 			 	params.reservation_id=$('#reservation_id','#dispatch_repair').val();
	 				params.electricianNames=$('#electrician','#dispatch_repair').val();
	 				params.electricianIds=$('#electricianIds','#dispatch_repair').val();
	 				params.electrician_phone=$('#electrician_phone','#dispatch_repair').val();
	 				params.start_time=$('#start_time','#dispatch_repair').val();
	 				params.duration=$('#duration','#dispatch_repair').val();
	 	  		 	alert(JSON.stringify(params));
	 	  		 	if(window.confirm('确定保存接单吗?')){
	 	  		 	 if(!params.electricianIds){
	 	          	   alert('请选择电工！');
	 	          	   return false;
	 	             }
	 	  		 	 
	 	  		 	if(!params.start_time){
	 	           	   alert('请输入开始时间！');
	 	           	   return false;
	 	              }
	 	  		 
	 	  		 	if(!params.duration){
	 	           	   alert('请输入预计时长！');
	 	           	   return false;
	 	              } 
	 	  		 		
	 	                 $.ajax( {
	 		           		  type : 'post', 
	 		           		  async: false,   
	 		           		  contentType : 'application/json',     
	 		           		  dataType : 'json',     
	 		           		  url : url,   
	 		           		  data:JSON.stringify(params),
	 		           		  success : function(data) {
	 		           			  if(data){
	 		           				 if(data.success){
	 		           					 $('#dispatchgrid').sgDatagrid('reload','sgDatagrid');
	 		           				 }
	 		           				 alert(data.msg);
	 		           			  }
	 		           		  } ,     
	 		           		  error : function(res,error) { 
	 		           		  	 alert(res.responseText);     
	 		           		  }    
	 		           		}); 
	 	  		 	}
	 		        $('#dispatch_repair').unbind();//以下两行可以阻止提交2次，暂时注释，也不会提交2次
	 		        $(document).sgWindow('close', {id : 'dispathch'});
	 		    	return false;
	 		 	   }; 
	 	    
	 		 	   
	 		 	   

	 		 	    var save3 = function(){
	 		 		    	//做表单提交
	 		 		        var params = {};
	 		 		    	var url='dispatchTask/add';
	 		 			 	params.task_id=$('#taskId','#dispathch_police').val();
	 		 			 	params.reservation_id=$('#reservation_id','#dispathch_police').val();
	 		 				params.electricianNames=$('#electrician','#dispathch_police').val();
	 		 				params.electricianIds=$('#electricianIds','#dispathch_police').val();
	 		 				params.electrician_phone=$('#electrician_phone','#dispathch_police').val();
	 		 				params.start_time=$('#start_time','#dispathch_police').val();
	 		 				params.duration=$('#duration','#dispathch_police').val();
	 		 	  		 	alert(JSON.stringify(params));
	 		 	  		 	if(window.confirm('确定保存接单吗?')){
	 		 	  		 	 if(!params.electricianIds){
	 		 	          	   alert('请选择电工！');
	 		 	          	   return false;
	 		 	             }
	 		 	  		 	 
	 		 	  		 	if(!params.start_time){
	 		 	           	   alert('请输入开始时间！');
	 		 	           	   return false;
	 		 	              }
	 		 	  		 
	 		 	  		 	if(!params.duration){
	 		 	           	   alert('请输入预计时长！');
	 		 	           	   return false;
	 		 	              } 
	 		 	  		 		
	 		 	                 $.ajax( {
	 		 		           		  type : 'post', 
	 		 		           		  async: false,   
	 		 		           		  contentType : 'application/json',     
	 		 		           		  dataType : 'json',     
	 		 		           		  url : url,   
	 		 		           		  data:JSON.stringify(params),
	 		 		           		  success : function(data) {
	 		 		           			  if(data){
	 		 		           				 if(data.success){
	 		 		           					 $('#dispatchgrid').sgDatagrid('reload','sgDatagrid');
	 		 		           				 }
	 		 		           				 alert(data.msg);
	 		 		           			  }
	 		 		           		  } ,     
	 		 		           		  error : function(res,error) { 
	 		 		           		  	 alert(res.responseText);     
	 		 		           		  }    
	 		 		           		}); 
	 		 	  		 	}
	 		 		        $('#dispathch_police').unbind();//以下两行可以阻止提交2次，暂时注释，也不会提交2次
	 		 		        $(document).sgWindow('close', {id : 'dispathch'});
	 		 		    	return false;
	 		 		 	   }; 
	 		 	    
	 		 		 	   
	 		 		 	   

	 		 		     var save4 = function(){
	 		 		 	    	//做表单提交
	 		 		 	        var params = {};
	 		 		 	    	var url='dispatchTask/add';
	 		 		 		 	params.task_id=$('#taskId','#dispathch_other').val();
	 		 		 		 	params.reservation_id=$('#reservation_id','#dispathch_other').val();
	 		 		 			params.electricianNames=$('#electrician','#dispathch_other').val();
	 		 		 			params.electricianIds=$('#electricianIds','#dispathch_other').val();
	 		 		 			params.electrician_phone=$('#electrician_phone','#dispathch_other').val();
	 		 		 			params.start_time=$('#start_time','#dispathch_other').val();
	 		 		 			params.duration=$('#duration','#dispathch_other').val();
	 		 		   		 	alert(JSON.stringify(params));
	 		 		   		 	if(window.confirm('确定保存接单吗?')){
	 		 		   		 	 if(!params.electricianIds){
	 		 		           	   alert('请选择电工！');
	 		 		           	   return false;
	 		 		              }
	 		 		   		 	 
	 		 		   		 	if(!params.start_time){
	 		 		            	   alert('请输入开始时间！');
	 		 		            	   return false;
	 		 		               }
	 		 		   		 
	 		 		   		 	if(!params.duration){
	 		 		            	   alert('请输入预计时长！');
	 		 		            	   return false;
	 		 		               } 
	 		 		   		 		
	 		 		                  $.ajax( {
	 		 		 	           		  type : 'post', 
	 		 		 	           		  async: false,   
	 		 		 	           		  contentType : 'application/json',     
	 		 		 	           		  dataType : 'json',     
	 		 		 	           		  url : url,   
	 		 		 	           		  data:JSON.stringify(params),
	 		 		 	           		  success : function(data) {
	 		 		 	           			  if(data){
	 		 		 	           				 if(data.success){
	 		 		 	           					 $('#dispatchgrid').sgDatagrid('reload','sgDatagrid');
	 		 		 	           				 }
	 		 		 	           				 alert(data.msg);
	 		 		 	           			  }
	 		 		 	           		  } ,     
	 		 		 	           		  error : function(res,error) { 
	 		 		 	           		  	 alert(res.responseText);     
	 		 		 	           		  }    
	 		 		 	           		}); 
	 		 		   		 	}
	 		 		 	        $('#dispathch_other').unbind();//以下两行可以阻止提交2次，暂时注释，也不会提交2次
	 		 		 	        $(document).sgWindow('close', {id : 'dispathch'});
	 		 		 	    	return false;
	 		 		 	 	   }; 
	 		 		     
	 	   
	 	   
    var today = new Date().format('yyyy-MM-dd');
    var twoDayBefore = GetDateStr(-2);

    var defaults = {
        title: "工单管理",
        width:  720,
        height: 395,
        url: 'task/findTasksByPage',
        datatype:"json",
        usepager: true,
	    rownumbers:true,
        useRp: true,
        colid:'id',  //主键
        query:{tStatus:-1},
        colModel : [
            {display: '工单号', name : 'billnum', width : 110, sortable : false},
            {display: '业务', name : 'type', width : 70, sortable : true,formatter:function(value,row){
                if(value==0){
                    value = '新装';
                }else if(value==1){
                    value = '维修';
                }else if(value==2){
                    value = '回收';
                }else if(value==3){
                    value = '拆除';
                }else if(value==4){
                    value = '抢修';
                }else if(value==5){
                    value = '换装';
                }else if(value==6){
                    value = '过户';
                }else if(value==7){
                    value = '升级';
                }else if(value==8){
                    value = '换号';
                }else if(value==9){
                    value = '办停';
                }else if(value==10){
                    value = '其他业务';
                }else if(value==11){
                    value = '更改资料';
                }else if(value==12){
                    value = '重新开通';
                }else if(value==13){
                    value = '新业务办理';
                }
                return value;
            }},
            {display: '客户', name : 'customerName', width : 70, sortable : false},
            {display: '车牌号', name : 'carNum', width : 70, sortable : false},
            {display: '状态', name : 'status', width : 60, sortable : true,formatter:function(value,row){
                if(value==1){
                    value = '待预约';
                }else if(value==2){
                    value = '已预约';
                }else if(value==3){
                    value = '已派工';
                }else if(value==4){
                    value = '处理中';
                }else if(value==5){
                    value = '结束';
                }
                return value;
            }},
            {display: '电工', name : 'eNames', width : 70, sortable : false},
            {display: '受理时间', name : 'time', width : 110, sortable : false}
        ],
        buttons : [
			{name: '工单查看调度', bclass: 'add', onpress : viewItem},
			{separator: true},
            {name: '工单作废', bclass: 'delete', onpress : deleteItem},
            {separator: true},
            {name: '派工', bclass: 'add', onpress : dispatchItem},
            {separator: true},
            {name: '跟单', bclass: 'add', onpress : followItem},
            {separator: true},
            {name: '工单结束', bclass: 'add', onpress : endItem},
            {separator: true}
        ],
        searchitems :[
            {display:'车牌号',name:'carNum',type:'text',width:'100'},
            //{display:'电工',name:'eNames',type:'text',width:'100'},
            {display:'业务',name:'type',html:'<select name="type"><option value="" selected>请选择...</option><option value="0">新装</option><option value="1">维修</option><option value="2">升级</option><option value="3">换装</option><option value="6">过户</option><option value="7">办停</option></select>'},
            {display:'状态',name:'status',html:'<select name="status"><option value="" selected>请选择...</option><option value="0">待预约</option><option value="1">已预约</option><option value="2">已派工</option><option value="3">处理中</option><option value="4">处理完</option><option value="5">回单</option></select>'},
            {display:'开始时间',name:'startDate',type:'date',width:'130px',value:twoDayBefore},
	      	{display:'结束时间',name:'endDate',type:'date',width:'130px',value:today}
        ],
        sortname: "id",
        sortorder: "desc"
    };
    $('#dispatchgrid').sgDatagrid(defaults);
})(jQuery);
</script>
</html>