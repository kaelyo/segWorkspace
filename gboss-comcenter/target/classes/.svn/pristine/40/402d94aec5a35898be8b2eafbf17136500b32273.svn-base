/*!
 * 
acceptAlarmACK * Copyright 2014 chinagps, Inc. zhangxz
 * 通信中心websocket协议 
 * 类中var函数调this变量，用this不行，要自定义一个变量selfclient
 * 
 * zhangxz 2014-09-30 添加坐席新功能
 * 
 */
"use strict";if(typeof Zlib==="undefined"){throw new Error("segseatlib requires zlib")}if(typeof SEGUtil_WS==="undefined"){throw new Error("segseatlib requires segutil_ws")}if(typeof dcodeIO==="undefined"||!dcodeIO.ByteBuffer||!dcodeIO.ProtoBuf||comcenterprotobuf==null){throw (new Error("ProtoBuf.js is not present"))}var segseatlib={timetask:null,clientes:[],heartbeatinterval:10000,STX:254,bytebuffer:null,protobuf:null,builder:null,centermessage:null,basemessage:null,message_type:{Login:1001,Login_ACK:8001,Logout:1002,Logout_ACK:8002,ActiveLink:1003,ActiveLink_ACK:8003,AddMonitor:1011,AddMonitor_ACK:8011,RemoveMonitor:1012,RemoveMonitor_ACK:8012,GetLastInfo:1013,GetLastInfo_ACK:8013,GetHistoryInfo:1014,GetHistoryInfoNextPage:1015,GetHistoryInfo_ACK:8014,StopHistoryInfo:1016,StopHistoryInfo_ACK:8016,GetHistorySimpleGpsInfo_ACK:8017,SendCommand:1051,SendCommand_ACK:8051,SendCommandSend_ACK:8052,GetCommandHistory:1053,GetCommandHistory_ACK:8053,TestDeliver:2000,DeliverGPS:2001,DeliverOperateData:2002,DeliverSMS:2003,DeliverUnitLoginOut:2004,DeliverTravel:2005,DeliverFault:2006,DeliverAlarm:2007,DeliverSimpleGPS:2008,DeliverOBD:2009,DeliverAppNotice:2010,DeliverUnitVersion:2011,DeliverFaultLight:2012,DeliverECUConfig:2013,SetAlarmBusy:3001,SetAlarmBusy_ACK:10001,AllotAlarm:3002,AllotAlarm_ACK:10002,PauseAlarm:3003,PauseAlarm_ACK:10003,CancelPauseAlarm:3013,CancelPauseAlarm_ACK:10013,HandleAlarm:3004,HandleAlarm_ACK:10004,AskSeatList:3005,AskSeatList_ACK:10005,TransferAlarm:3006,TransferAlarm_ACK:10006,AllotTransferAlarm:3007,AllotTransferAlarm_ACK:10007,AskAlarmList:3008,AskAlarmList_ACK:10008,NewAlarm:4002,NewAlarm_ACK:12002,},resultcode:{OK:0,UserName:1,Password:2,UserExist:3,LoginNameExist:4,MobileExist:5,EmailExist:6,UserNoExist:7,LoginNameEdit:8,VehicleNoExist:9,UnitNoExist:10,UserNoVehicle:11,VehicleNoUnit:12,CallLetterExist:13,UnitNoAck:14,CommandID:15,Parameters:16,Send:17,Timeout:18,CompanyNoExist:20,NoLogin:21,DataBase:22,ConnectFail:23,Encode:24,Decode:25,Format:26,TimeError:27,NoRequest:28,Shutdowm:29,SeatNoLogin:40,AlarmNoExist:41,AlarmHandled:42,SeatExist:43,SeatBusy:44,Seat:45,Hbase:101,LastPosition:102,HistoryPosition:103,HistoryPositionNoStart:104,LastTravel:105,HistoryTravel:106,HistoryTravelNotStart:107,LastFault:108,HistoryFault:109,HistoryFaultNotStart:110,LastAlarm:111,HistoryAlarm:112,HistoryAlarmNoStart:113,LastOperateData:114,HistoryOperateData:115,HistoryOperateDataNoStart:116,LastSm:117,HistorySm:118,HistorySmNoStart:119,RefuseAlarm:201,AppendAlarm:211,Other:-1,},isWebSocketSupport:function(){var supportWebSocket=typeof(WebSocket)!="undefined";var supportDataView=typeof(DataView)!="undefined";var supportArrayBuffer=typeof(ArrayBuffer)!="undefined";var supportInt8Array=typeof(Int8Array)!="undefined";return supportWebSocket&&supportDataView&&supportArrayBuffer&&supportInt8Array},init:function(){if(!segseatlib.isWebSocketSupport()){return}if(segseatlib.protobuf==null){segseatlib.bytebuffer=dcodeIO.ByteBuffer;segseatlib.protobuf=dcodeIO.ProtoBuf;segseatlib.builder=segseatlib.protobuf.protoFromString(comcenterprotobuf);comcenterprotobuf=null;segseatlib.centermessage=segseatlib.builder.build("ComCenterMessage");segseatlib.basemessage=segseatlib.builder.build("ComCenterMessage.ComCenterBaseMessage")}},setTimeoutTask:function(){if(segseatlib.timetask!=null){return}segseatlib.timetask=setInterval(function(){try{var arr=segseatlib.clientes;for(var i=0;i<arr.length;i++){if((typeof arr[i]==="object")&&(typeof arr[i].timeout==="function")){arr[i].timeout()}}}catch(err){alert("timeout error:"+err)}},10000)},addClient:function(segclient){var index=SEGUtil_WS.indexOfArray(segseatlib.clientes,segclient);if(index==-1){segseatlib.clientes.push(segclient);segseatlib.setTimeoutTask()}},removeClient:function(segclient){var index=SEGUtil_WS.indexOfArray(segseatlib.clientes,segclient);if(index!=-1){segseatlib.clientes.splice(index,1);segclient.close();if(segseatlib.clientes.length==0){clearInterval(segseatlib.timetask);segseatlib.timetask=null}}},removeClientByID:function(_id){var arr=segseatlib.clientes;for(var i=0;i<arr.length;i++){if(arr[i].id==_id){segseatlib.clientes.splice(i,1);return}}},encode:function(src,compress,encrypt){try{if(src.byteLength==0){return null}if(src.byteLength<256){compress=false}if(compress){src=segseatlib.Utils.compress(src)}if(src==null||src.byteLength>65520){return null}if(encrypt){src=segseatlib.Utils.encrypt(src)}var totallen=src.byteLength+12;var buff=new Uint8Array(totallen);buff[0]=segseatlib.STX;buff[1]=16;buff[2]=compress?1:0;buff[3]=encrypt?1:0;buff[4]=(totallen>>>8)&255;buff[5]=(totallen)&255;buff[6]=0;buff[7]=0;segseatlib.Utils.byteArrayCopy(buff,8,src);var crc32=SEGUtil_WS.crc32(buff,totallen-4);segseatlib.Utils.int32ToByteArray(buff,totallen-4,crc32);return buff}catch(err){SEGUtil_WS.showError("websocket协议编码失败:"+err);
return null}return null},decode:function(recv){try{if(recv.byteLength<=12){return null}if(recv[0]!=segseatlib.STX){return null}if(SEGUtil_WS.getShortFromByteArray(recv,4)!=recv.byteLength){return null}var crc32c=SEGUtil_WS.crc32(recv,recv.byteLength-4);var crc32s=SEGUtil_WS.getIntFromByteArray(recv,recv.byteLength-4);if(crc32c!=crc32s){return null}var iscompress=recv[2];var isencrypt=recv[3];var content=new Uint8Array(recv.byteLength-12);segseatlib.Utils.byteArrayCopy(content,0,recv,8,recv.byteLength-4);if(isencrypt==1){content=segseatlib.Utils.decrypt(content)}if(iscompress==1){var inflate=new Zlib.Inflate(content);content=inflate.decompress()}return content}catch(err){SEGUtil_WS.showError("websocket协议解码码失败:"+err);return null}return null},int8ArrayToByteBuffer:function(arr,littleEndian){var k=arr.length;var dst=new ArrayBuffer(k);var view=new DataView(dst);for(var i=0;i<k;++i){view.setUint8(i,arr[i])}var bb=new segseatlib.bytebuffer(k,littleEndian,true);bb.array=dst;bb.view=view;bb.length=k;return bb},jsclient:function(_id,_hosts,_username,_password,_seatid,_usertype,_userversion){segseatlib.init();this.id=_id;var socket=null;var server=null;var serverid=0;var username="";var password="";var usertype="";var userversion="";var seatid=null;var compress=false;var encrypt=false;var lasttime=new Date().getTime();var loginstatus=0;var ismanualclose=false;var selfclient=this;var seatbusy=null;var seatbusycaller=null;var monitorcaller=null;if(typeof _hosts==="string"){server=_hosts.split(";")}else{if(typeof _hosts==="object"){server=_hosts}}if(typeof _username==="string"){username=_username}if(typeof _password==="string"){password=_password}if(typeof _seatid==="string"){seatid=_seatid}if(typeof _usertype==="string"){usertype=_usertype}if(typeof _userversion==="string"){userversion=_userversion}this.isConnected=function(){return(socket!=null)&&(socket.readyState==WebSocket.OPEN)};this.isLogined=function(){return(loginstatus==2)&&(socket!=null)&&(socket.readyState==WebSocket.OPEN)};this.setCompress=function(b){if(typeof b==="boolean"){compress=b}else{compress=true}};this.setEncrypt=function(b){if(typeof b==="boolean"){encrypt=b}else{encrypt=true}};this.send=function(buff){if(!selfclient.isConnected()){return segseatlib.resultcode.ConnectFail}if(typeof(buff.byteLength)!="undefined"){var int8arr=segseatlib.encode(buff,compress,encrypt);if(int8arr==null){return segseatlib.resultcode.Encode}socket.send(int8arr.buffer)}else{socket.send(buff)}return segseatlib.resultcode.OK};var login=function(){console.log("logining");if(!selfclient.isConnected()){return}var loginbuilder=segseatlib.builder.build("Login");var loginobj=new loginbuilder(username,password,monitorcaller,seatid,usertype,userversion);var basemsg=new segseatlib.basemessage(segseatlib.message_type.Login,loginobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});selfclient.send(new Uint8Array(msg.toArrayBuffer()));loginstatus=1;ismanualclose=false};var logout=function(){console.log("logouting");if(!selfclient.isLogined()){return}var logoutmsg=new segseatlib.basemessage(segseatlib.message_type.Logout);var msg=new segseatlib.centermessage({"messages":[logoutmsg]});ismanualclose=true;selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.activelink=function(){console.log("activelink");var activelinkmsg=new segseatlib.basemessage(segseatlib.message_type.ActiveLink);var msg=new segseatlib.centermessage({"messages":[activelinkmsg]});selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.addMonitor=function(callletterlist,infotypelist,clearold){console.log("addmonitor");if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("AddMonitor");var tmpobj=new tmpbuilder(callletterlist,infotypelist);if(clearold){tmpobj=new tmpbuilder(callletterlist,infotypelist,true)}var basemsg=new segseatlib.basemessage(segseatlib.message_type.AddMonitor,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.removeMonitor=function(callletterlist,infotypelist){console.log("removemonitor");if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("RemoveMonitor");var tmpobj=new tmpbuilder(callletterlist,infotypelist);var basemsg=new segseatlib.basemessage(segseatlib.message_type.RemoveMonitor,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.getLastInfo=function(infotype,callletterlist,sn){console.log("getlastinfo: "+infotype);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("GetLastInfo");var tmpobj=new tmpbuilder(infotype,callletterlist,sn);var basemsg=new segseatlib.basemessage(segseatlib.message_type.GetLastInfo,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))
};this.getHistoryInfo=function(callletter,infotype,starttime,endtime,pageNumber,totalNumber,autonextpage,sn,norepeat,reversed){console.log("gethistoryinfo: "+infotype);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var startseconds=starttime.getTime();var endseconds=endtime.getTime();var tmpbuilder=segseatlib.builder.build("GetHistoryInfo");var tmpobj=new tmpbuilder(callletter,infotype,startseconds,endseconds,pageNumber,totalNumber,autonextpage,sn,reversed,norepeat);var basemsg=new segseatlib.basemessage(segseatlib.message_type.GetHistoryInfo,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.getHistoryNextPage=function(callletter,infotype,sn){console.log("GetHistoryInfoNextPage");if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("GetHistoryInfoNextPage");var tmpobj=new tmpbuilder(callletter,infotype,sn);var basemsg=new segseatlib.basemessage(segseatlib.message_type.GetHistoryInfoNextPage,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.stopHistory=function(callletter,infotype,sn){console.log("StopHistoryInfo");if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("StopHistoryInfo");var tmpobj=new tmpbuilder(callletter,infotype,sn);var basemsg=new segseatlib.basemessage(segseatlib.message_type.StopHistoryInfo,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.getCommandHistory=function(callletter,starttime,endtime){console.log("getcommandhistory: "+callletter);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var startseconds=starttime.getTime();var endseconds=endtime.getTime();var tmpbuilder=segseatlib.builder.build("GetCommandHistory");var tmpobj=new tmpbuilder(callletter,startseconds,endseconds);var basemsg=new segseatlib.basemessage(segseatlib.message_type.GetCommandHistory,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.sendUnitCommand=function(sn,callletterlist,cmdid,params,addmonitor){console.log("SendCommand "+cmdid);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("SendCommand");var tmpobj=new tmpbuilder(sn,callletterlist,cmdid,params);if(addmonitor){tmpobj=new tmpbuilder(sn,callletterlist,cmdid,params,null,null,true)}var basemsg=new segseatlib.basemessage(segseatlib.message_type.SendCommand,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.setAlarmBusy=function(seatname,seatid,busy,callletter){console.log("SetAlarmBusy "+seatname);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("SetAlarmBusy");var tmpobj=new tmpbuilder(seatname,seatid,busy);seatbusycaller=null;if(busy==true&&callletter!=null){seatbusycaller=callletter;tmpobj=new tmpbuilder(seatname,seatid,busy,callletter)}var basemsg=new segseatlib.basemessage(segseatlib.message_type.SetAlarmBusy,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.acceptAlarmACK=function(accept,seatname,callletter,alarmsn){console.log("AcceptAlarmACK "+alarmsn);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("AllotAlarm_ACK");var retcode=segseatlib.resultcode.OK;var retmsg="接受处警";if(accept!=true){retcode=segseatlib.resultcode.RefuseAlarm;retmsg="拒绝处警"}var tmpobj=new tmpbuilder(retcode,retmsg,seatname,callletter,alarmsn);var basemsg=new segseatlib.basemessage(segseatlib.message_type.AllotAlarm_ACK,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.pauseAlarm=function(seatname,callletter,alarmsn,pausemsg){console.log("PauseAlarm "+alarmsn);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("PauseAlarm");var tmpobj=new tmpbuilder(seatname,callletter,alarmsn,pausemsg);var basemsg=new segseatlib.basemessage(segseatlib.message_type.PauseAlarm,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.CancelPauseAlarm=function(seatname,callletter,alarmsn){console.log("CancelPauseAlarm "+alarmsn);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("CancelPauseAlarm");var tmpobj=new tmpbuilder(seatname,callletter,alarmsn);var basemsg=new segseatlib.basemessage(segseatlib.message_type.CancelPauseAlarm,tmpobj.toArrayBuffer());
var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.HandleAlarm=function(seatname,callletter,alarmsn,handlecode,handlemsg){console.log("HandleAlarm "+alarmsn);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("HandleAlarm");var tmpobj=new tmpbuilder(seatname,callletter,alarmsn,handlecode,handlemsg);var basemsg=new segseatlib.basemessage(segseatlib.message_type.HandleAlarm,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.AskSeatList=function(seatname,callletter,isidle){console.log("AskSeatList "+seatname);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}if(isidle!=false){isidle=true}var tmpbuilder=segseatlib.builder.build("AskSeatList");var tmpobj=new tmpbuilder(seatname,callletter,isidle,true);var basemsg=new segseatlib.basemessage(segseatlib.message_type.AskSeatList,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.TransferAlarm=function(srcseatname,dstseatname,callletter,alarmsn,transfermsg){console.log("TransferAlarm "+alarmsn);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("TransferAlarm");var tmpobj=new tmpbuilder(srcseatname,dstseatname,callletter,alarmsn,transfermsg);var basemsg=new segseatlib.basemessage(segseatlib.message_type.TransferAlarm,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.AllotTransferAlarmACK=function(accept,seatname,callletter,alarmsn,srcseatname){console.log("AllotTransferAlarmACK "+alarmsn);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var retcode=segseatlib.resultcode.OK;var retmsg="同意转警";if(accept!=true){retcode=segseatlib.resultcode.RefuseAlarm;retmsg="拒绝转警"}var tmpbuilder=segseatlib.builder.build("AllotTransferAlarm_ACK");var tmpobj=new tmpbuilder(retcode,retmsg,seatname,callletter,alarmsn,srcseatname);var basemsg=new segseatlib.basemessage(segseatlib.message_type.AllotTransferAlarm_ACK,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.AskAlarmList=function(seatname,onlyself,onlycount){console.log("AskAlarmList "+alarmsn);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}if(onlyself!=false){onlyself=true}if(onlycount!=false){onlycount=true}var tmpbuilder=segseatlib.builder.build("AskAlarmList");var tmpobj=new tmpbuilder(seatname,onlyself,onlycount);var basemsg=new segseatlib.basemessage(segseatlib.message_type.AskAlarmList,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.NewAlarm=function(seatname,callletter,alarmsn,alarmTime,alarmid,level,gpsTime,loc,lat,lng,speed,course,status){console.log("NewAlarm "+alarmsn);if(!selfclient.isLogined()){return segseatlib.resultcode.NoLogin}var tmpbuilder=segseatlib.builder.build("GpsSimpleInfo");var tmpgps=new tmpbuilder(gpsTime,loc,lat,lng,speed,course,status.split(","));tmpbuilder=segseatlib.builder.build("NewAlarm");var tmpobj=new tmpbuilder(seatname,callletter,alarmsn,alarmTime,alarmid,level,tmpgps);var basemsg=new segseatlib.basemessage(segseatlib.message_type.NewAlarm,tmpobj.toArrayBuffer());var msg=new segseatlib.centermessage({"messages":[basemsg]});return selfclient.send(new Uint8Array(msg.toArrayBuffer()))};this.openEvent=function(evt){try{lasttime=new Date().getTime();onopen(selfclient,evt);login()}catch(err){SEGUtil_WS.showError(err)}};this.errorEvent=function(event){try{onerror(selfclient,event)}catch(err){SEGUtil_WS.showError(err)}};this.closeEvent=function(event){try{loginstatus=0;onclose(selfclient,event);if(!ismanualclose){selfclient.connect()}}catch(err){SEGUtil_WS.showError(err)}};this.receiveEvent=function(event){try{lasttime=new Date().getTime();var msg=segseatlib.decode(new Uint8Array(event.data));if(msg!=null){var buff=segseatlib.int8ArrayToByteBuffer(msg);var msg=segseatlib.centermessage.decode(buff);buff=null;for(var i=0;i<msg.messages.length;i++){processMessage(msg.messages[i])}}}catch(err){SEGUtil_WS.showError("receive error:"+err)}};var processMessage=function(basemsg){switch(basemsg.id){case segseatlib.message_type.DeliverGPS:processDeliverGPS(basemsg.content);break;case segseatlib.message_type.SendCommand_ACK:processSendCommandACK(basemsg.content);break;case segseatlib.message_type.SendCommandSend_ACK:processSendCommandSendACK(basemsg.content);break;case segseatlib.message_type.GetLastInfo_ACK:processGetLastInfoACK(basemsg.content);break;case segseatlib.message_type.DeliverOperateData:processDeliverOperateData(basemsg.content);break;case segseatlib.message_type.DeliverSMS:processDeliverSMS(basemsg.content);
break;case segseatlib.message_type.DeliverUnitLoginOut:processDeliverUnitLoginOut(basemsg.content);break;case segseatlib.message_type.DeliverTravel:processDeliverTravel(basemsg.content);break;case segseatlib.message_type.DeliverFault:processDeliverFault(basemsg.content);break;case segseatlib.message_type.DeliverAlarm:processDeliverAlarm(basemsg.content);break;case segseatlib.message_type.DeliverAppNotice:processDeliverAppNotice(basemsg.content);break;case segseatlib.message_type.DeliverOBD:processDeliverOBD(basemsg.content);break;case segseatlib.message_type.DeliverUnitVersion:processDeliverUnitVersion(basemsg.content);break;case segseatlib.message_type.DeliverECUConfig:processDeliverECUConfig(basemsg.content);break;case segseatlib.message_type.GetHistoryInfo_ACK:processGetHistoryInfoACK(basemsg.content);break;case segseatlib.message_type.GetHistorySimpleGpsInfo_ACK:processGetHistorySimpleGpsInfoACK(basemsg.content);break;case segseatlib.message_type.GetCommandHistory_ACK:processGetCommandHistoryACK(basemsg.content);break;case segseatlib.message_type.Login_ACK:processLoginACK(basemsg.content);break;case segseatlib.message_type.ActiveLink:processActiveLink(basemsg.content);break;case segseatlib.message_type.AddMonitor_ACK:processAddMonitorACK(basemsg.content);break;case segseatlib.message_type.RemoveMonitor_ACK:processRemoveMonitorACK(basemsg.content);break;case segseatlib.message_type.StopHistoryInfo_ACK:processStopHistoryInfoACK(basemsg.content);break;case segseatlib.message_type.SetAlarmBusy_ACK:processSetAlarmBusyACK(basemsg.content);break;case segseatlib.message_type.AllotAlarm:processAllotAlarm(basemsg.content);break;case segseatlib.message_type.PauseAlarm_ACK:processPauseAlarmACK(basemsg.content);break;case segseatlib.message_type.CancelPauseAlarm_ACK:processCancelPauseAlarmACK(basemsg.content);break;case segseatlib.message_type.HandleAlarm_ACK:processHandleAlarmACK(basemsg.content);break;case segseatlib.message_type.AskSeatList_ACK:processAskSeatListACK(basemsg.content);break;case segseatlib.message_type.TransferAlarm_ACK:processTransferAlarmACK(basemsg.content);break;case segseatlib.message_type.AllotTransferAlarm:processAllotTransferAlarm(basemsg.content);break;case segseatlib.message_type.AskAlarmList_ACK:processAskAlarmListACK(basemsg.content);break;case segseatlib.message_type.NewAlarm_ACK:processNewAlarmACK(basemsg.content);break;default:break}};var processLoginACK=function(content){try{var loginack=segseatlib.builder.build("Login_ACK");loginack=loginack.decode(content);if(loginack.retcode==segseatlib.resultcode.OK){loginstatus=2}else{loginstatus=0}if(loginack.retcode==segseatlib.resultcode.OK){if(monitorcaller!=null){selfclient.addMonitor(monitorcaller,-1,false)}if(seatbusy!=null){selfclient.setAlarmBusy(username,seatid,seatbusy,seatbusycaller)}}if(typeof(onlogin)!="undefined"){onlogin(selfclient,loginack.retcode,loginack.retmsg)}}catch(err){SEGUtil_WS.showError("Login ACK error:"+err)}};var processActiveLink=function(content){var basemsg=new segseatlib.basemessage(segseatlib.message_type.ActiveLink_ACK);var msg=new segseatlib.centermessage({"messages":[basemsg]});selfclient.send(new Uint8Array(msg.toArrayBuffer()))};var processAddMonitorACK=function(content){try{var addmonitorack=segseatlib.builder.build("AddMonitor_ACK");addmonitorack=addmonitorack.decode(content);if(addmonitorack.retcode==segseatlib.resultcode.OK){monitorcaller=addmonitorack.callLetters;if(monitorcaller!=null&&monitorcaller.length==0){monitorcaller=null}}if(typeof(onaddmonitor)!="undefined"){onaddmonitor(selfclient,addmonitorack.retcode,addmonitorack.retmsg,addmonitorack.callLetters)}}catch(err){SEGUtil_WS.showError("AddMonitor ACK error:"+err)}};var processRemoveMonitorACK=function(content){try{var removeack=segseatlib.builder.build("RemoveMonitor_ACK");removeack=removeack.decode(content);if(removeack.retcode==segseatlib.resultcode.OK){monitorcaller=removeack.callLetters;if(monitorcaller!=null&&monitorcaller.length==0){monitorcaller=null}}if(typeof(onremovemonitor)!="undefined"){onremovemonitor(selfclient,removeack.retcode,removeack.retmsg,removeack.callLetters)}}catch(err){SEGUtil_WS.showError("RemoveMonitor ACK error:"+err)}};var processGetLastInfoACK=function(content){try{var lastack=segseatlib.builder.build("GetLastInfo_ACK");lastack=lastack.decode(content);if(lastack.gpses.length>0&&typeof(ongetlastgps)!="undefined"){ongetlastgps(selfclient,lastack.retcode,lastack.retmsg,lastack.gpses,lastack.timestamps)}if(lastack.travels.length>0&&typeof(ongetlasttravel)!="undefined"){ongetlasttravel(selfclient,lastack.retcode,lastack.retmsg,lastack.travels,lastack.timestamps)}if(lastack.faults.length>0&&typeof(ongetlastfault)!="undefined"){ongetlastfault(selfclient,lastack.retcode,lastack.retmsg,lastack.faults,lastack.timestamps)}if(lastack.operates.length>0&&typeof(ongetlastoperate)!="undefined"){ongetlastoperate(selfclient,lastack.retcode,lastack.retmsg,lastack.operates,lastack.timestamps)}if(lastack.sms.length>0&&typeof(ongetlastsm)!="undefined"){ongetlastsm(selfclient,lastack.retcode,lastack.retmsg,lastack.sms,lastack.timestamps)
}if(lastack.alarms.length>0&&typeof(ongetlastalarm)!="undefined"){ongetlastalarm(selfclient,lastack.retcode,lastack.retmsg,lastack.alarms,lastack.timestamps)}if(lastack.obds.length>0&&typeof(ongetlastobd)!="undefined"){ongetlastobd(selfclient,lastack.retcode,lastack.retmsg,lastack.obds,lastack.timestamps)}if(lastack.unitloginout.length>0&&typeof(ongetlastunitloginout)!="undefined"){ongetlastunitloginout(selfclient,lastack.retcode,lastack.retmsg,lastack.unitloginout,lastack.timestamps)}if(lastack.retcode!=0&&typeof(ongetlasterror)!="undefined"){ongetlasterror(selfclient,lastack.retcode,lastack.retmsg)}}catch(err){SEGUtil_WS.showError("GetLastInfo ACK error:"+err)}};var processGetHistoryInfoACK=function(content){try{var historyack=segseatlib.builder.build("GetHistoryInfo_ACK");historyack=historyack.decode(content);if(historyack.gpses.length>0&&typeof(ongethistorygps)!="undefined"){ongethistorygps(selfclient,historyack.retcode,historyack.retmsg,historyack.lastPage,historyack.gpses,historyack.timestamps)}if(historyack.travels.length>0&&typeof(ongethistorytravel)!="undefined"){ongethistorytravel(selfclient,historyack.retcode,historyack.retmsg,historyack.lastPage,historyack.travels,historyack.timestamps)}if(historyack.faults.length>0&&typeof(ongethistoryfault)!="undefined"){ongethistoryfault(selfclient,historyack.retcode,historyack.retmsg,historyack.lastPage,historyack.faults,historyack.timestamps)}if(historyack.operates.length>0&&typeof(ongethistoryoperate)!="undefined"){ongethistoryoperate(selfclient,historyack.retcode,historyack.retmsg,historyack.lastPage,historyack.operates,historyack.timestamps)}if(historyack.sms.length>0&&typeof(ongethistorysm)!="undefined"){ongethistorysm(selfclient,historyack.retcode,historyack.retmsg,historyack.lastPage,historyack.sms,historyack.timestamps)}if(historyack.alarms.length>0&&typeof(ongethistoryalarm)!="undefined"){ongethistoryalarm(selfclient,historyack.retcode,historyack.retmsg,historyack.lastPage,historyack.alarms,historyack.timestamps)}if(historyack.obds.length>0&&typeof(ongethistoryobd)!="undefined"){ongethistoryobd(selfclient,historyack.retcode,historyack.retmsg,historyack.lastPage,historyack.obds,historyack.timestamps)}if(historyack.unitloginout.length>0&&typeof(ongethistoryunitloginout)!="undefined"){ongethistoryunitloginout(selfclient,historyack.retcode,historyack.retmsg,historyack.lastPage,historyack.unitloginout,historyack.timestamps)}if(historyack.retcode!=0&&typeof(ongethistoryerror)!="undefined"){ongethistoryerror(selfclient,historyack.retcode,historyack.retmsg)}}catch(err){SEGUtil_WS.showError("GetHistoryInfo ACK error:"+err)}};var processGetHistorySimpleGpsInfoACK=function(content){try{var historyack=segseatlib.builder.build("GetHistorySimpleGpsInfo_ACK");historyack=historyack.decode(content);if(historyack.gpses.length>0&&typeof(ongethistorysimplegps)!="undefined"){ongethistorysimplegps(selfclient,historyack.callLetter,historyack.retcode,historyack.retmsg,historyack.lastPage,historyack.gpses,historyack.timestamps)}if(historyack.retcode!=0&&typeof(ongethistoryerror)!="undefined"){ongethistoryerror(selfclient,historyack.retcode,historyack.retmsg)}}catch(err){SEGUtil_WS.showError("GetHistoryInfo ACK error:"+err)}};var processStopHistoryInfoACK=function(content){try{var stopack=segseatlib.builder.build("StopHistoryInfo_ACK");stopack=stopack.decode(content);if(typeof(onstophistory)!="undefined"){onstophistory(selfclient,stopack.retcode,stopack.retmsg)}}catch(err){SEGUtil_WS.showError("GetHistoryInfo ACK error:"+err)}};var processDeliverGPS=function(content){try{var deliver=segseatlib.builder.build("DeliverGPS");deliver=deliver.decode(content);if(typeof(ondelivergps)!="undefined"){ondelivergps(selfclient,deliver.gpsinfo,deliver.gatewayid,deliver.gatewaytype,deliver.alarmid,deliver.alarmname)}}catch(err){SEGUtil_WS.showError("DeliverGPS error:"+err)}};var processDeliverAlarm=function(content){try{var deliver=segseatlib.builder.build("DeliverAlarm");deliver=deliver.decode(content);if(typeof(ondeliveralarm)!="undefined"){ondeliveralarm(selfclient,deliver.alarminfo,deliver.gatewayid,deliver.gatewaytype)}}catch(err){SEGUtil_WS.showError("DeliverAlarm error:"+err)}};var processDeliverAppNotice=function(content){try{var deliver=segseatlib.builder.build("DeliverAppNotice");deliver=deliver.decode(content);if(typeof(ondeliverappnotice)!="undefined"){ondeliverappnotice(selfclient,deliver.noticeinfo,deliver.gatewayid,deliver.gatewaytype)}}catch(err){SEGUtil_WS.showError("DeliverAppNotice error:"+err)}};var processDeliverOBD=function(content){try{var deliver=segseatlib.builder.build("DeliverOBD");deliver=deliver.decode(content);if(typeof(ondeliverobd)!="undefined"){ondeliverobd(selfclient,deliver.obdinfo,deliver.gatewayid,deliver.gatewaytype)}}catch(err){SEGUtil_WS.showError("DeliverOBD error:"+err)}};var processDeliverUnitVersion=function(content){try{var deliver=segseatlib.builder.build("DeliverUnitVersion");deliver=deliver.decode(content);if(typeof(ondeliverunitversion)!="undefined"){ondeliverunitversion(selfclient,deliver.unitVersion,deliver.gatewayid,deliver.gatewaytype)
}}catch(err){SEGUtil_WS.showError("DeliverUnitVersion error:"+err)}};var processDeliverOperateData=function(content){try{var deliver=segseatlib.builder.build("DeliverOperateData");deliver=deliver.decode(content);if(typeof(ondeliveroperatedata)!="undefined"){ondeliveroperatedata(selfclient,deliver.data,deliver.gatewayid,deliver.gatewaytype)}}catch(err){SEGUtil_WS.showError("DeliverOperateData error:"+err)}};var processDeliverSMS=function(content){try{var deliver=segseatlib.builder.build("DeliverSMS");deliver=deliver.decode(content);if(typeof(ondeliversms)!="undefined"){ondeliversms(selfclient,deliver.msg,deliver.gatewayid,deliver.gatewaytype)}}catch(err){SEGUtil_WS.showError("DeliverSMS error:"+err)}};var processDeliverUnitLoginOut=function(content){try{var deliver=segseatlib.builder.build("DeliverUnitLoginOut");deliver=deliver.decode(content);if(typeof(ondeliverunitloginout)!="undefined"){ondeliverunitloginout(selfclient,deliver.callLetter,deliver.inorout,deliver.gatewayid,deliver.unitversion)}}catch(err){SEGUtil_WS.showError("DeliverUnitLoginOut error:"+err)}};var processDeliverTravel=function(content){try{var deliver=segseatlib.builder.build("DeliverTravel");deliver=deliver.decode(content);if(typeof(ondelivertrival)!="undefined"){ondelivertrival(selfclient,deliver.travelinfo,deliver.gatewayid,deliver.gatewaytype)}}catch(err){SEGUtil_WS.showError("DeliverTravel error:"+err)}};var processDeliverFault=function(content){try{var deliver=segseatlib.builder.build("DeliverFault");deliver=deliver.decode(content);if(typeof(ondeliverfault)!="undefined"){ondeliverfault(selfclient,deliver.faultinfo,deliver.gatewayid,deliver.gatewaytype)}}catch(err){SEGUtil_WS.showError("DeliverFault error:"+err)}};var processDeliverECUConfig=function(content){try{var deliver=segseatlib.builder.build("DeliverECUConfig");deliver=deliver.decode(content);if(typeof(ondeliverecuconfig)!="undefined"){ondeliverecuconfig(selfclient,deliver.ecuConfig,deliver.gatewayid,deliver.gatewaytype)}}catch(err){SEGUtil_WS.showError("DeliverFault error:"+err)}};var processSendCommandACK=function(content){try{var cmdack=segseatlib.builder.build("SendCommand_ACK");cmdack=cmdack.decode(content);if(typeof(onsendcommand)!="undefined"){onsendcommand(selfclient,cmdack.sn,cmdack.callLetter,cmdack.cmdId,cmdack.retcode,cmdack.retmsg,cmdack.params,cmdack.gpsInfo)}}catch(err){SEGUtil_WS.showError("SendCommand ACK error:"+err)}};var processSendCommandSendACK=function(content){try{var cmdack=segseatlib.builder.build("SendCommandSend_ACK");cmdack=cmdack.decode(content);if(typeof(onsendcommandsend)!="undefined"){onsendcommandsend(selfclient,cmdack.sn,cmdack.callLetter,cmdack.cmdId,cmdack.retcode,cmdack.retmsg)}}catch(err){SEGUtil_WS.showError("SendCommand ACK error:"+err)}};var processGetCommandHistoryACK=function(content){try{var historyack=segseatlib.builder.build("GetCommandHistory_ACK");historyack=historyack.decode(content);if(typeof(ongetcommandhistory)!="undefined"){ongetcommandhistory(selfclient,historyack.retcode,historyack.retmsg,historyack.callLetter,historyack.plateno,historyack.commandinfoes)}}catch(err){SEGUtil_WS.showError("SendCommand ACK error:"+err)}};var processSetAlarmBusyACK=function(content){try{var ack=segseatlib.builder.build("SetAlarmBusy_ACK");ack=ack.decode(content);if(ack.retcode==segseatlib.resultcode.OK){seatbusy=ack.busy;if(!seatbusy){seatbusycaller=null}}if(typeof(onsetalarmbusy)!="undefined"){onsetalarmbusy(selfclient,ack.retcode,ack.retmsg,ack.username,ack.busy,ack.handleseatname)}}catch(err){SEGUtil_WS.showError("SetAlarmBusy ACK error:"+err)}};var processAllotAlarm=function(content){try{var pkg=segseatlib.builder.build("AllotAlarm");pkg=pkg.decode(content);selfclient.acceptAlarmACK(true,pkg.username,pkg.callLetter,pkg.alarmsn);if(typeof(onallotalarm)!="undefined"){onallotalarm(selfclient,pkg.username,pkg.callLetter,pkg.alarmsn,pkg.alarmTime,pkg.alarmid,pkg.alarmname,pkg.gpsinfo,pkg.alarmcount,pkg.append)}}catch(err){SEGUtil_WS.showError("AllotAlarm error:"+err)}};var processPauseAlarmACK=function(content){try{var pkg=segseatlib.builder.build("PauseAlarm_ACK");pkg=pkg.decode(content);if(typeof(onpausealarmack)!="undefined"){onpausealarmack(selfclient,pkg.retcode,pkg.retmsg,pkg.username,pkg.callLetter,pkg.alarmsn)}}catch(err){SEGUtil_WS.showError("PauseAlarm ACK error:"+err)}};var processCancelPauseAlarmACK=function(content){try{var pkg=segseatlib.builder.build("CancelPauseAlarm_ACK");pkg=pkg.decode(content);if(typeof(oncancelpausealarmack)!="undefined"){oncancelpausealarmack(selfclient,pkg.retcode,pkg.retmsg,pkg.username,pkg.callLetter,pkg.alarmsn)}}catch(err){SEGUtil_WS.showError("PauseAlarm ACK error:"+err)}};var processHandleAlarmACK=function(content){try{var pkg=segseatlib.builder.build("HandleAlarm_ACK");pkg=pkg.decode(content);if(typeof(onhandlealarmack)!="undefined"){onhandlealarmack(selfclient,pkg.retcode,pkg.retmsg,pkg.username,pkg.callLetter,pkg.alarmsn)}}catch(err){SEGUtil_WS.showError("HandleAlarm ACK error:"+err)}};var processAskSeatListACK=function(content){try{var pkg=segseatlib.builder.build("AskSeatList_ACK");
pkg=pkg.decode(content);if(typeof(onaskseatlistack)!="undefined"){onaskseatlistack(selfclient,pkg.retcode,pkg.retmsg,pkg.seats)}}catch(err){SEGUtil_WS.showError("AskSeatList ACK error:"+err)}};var processTransferAlarmACK=function(content){try{var pkg=segseatlib.builder.build("TransferAlarm_ACK");pkg=pkg.decode(content);if(typeof(ontransferalarmack)!="undefined"){ontransferalarmack(selfclient,pkg.retcode,pkg.retmsg,pkg.srcusername,pkg.dstusername,pkg.callLetter,pkg.alarmsn)}}catch(err){SEGUtil_WS.showError("TransferAlarm ACK error:"+err)}};var processAllotTransferAlarm=function(content){try{var pkg=segseatlib.builder.build("AllotTransferAlarm");pkg=pkg.decode(content);if(typeof(onallottransferalarm)!="undefined"){onallottransferalarm(selfclient,pkg.username,pkg.callLetter,pkg.alarmsn,pkg.alarmTime,pkg.alarmid,pkg.alarmname,pkg.gpsinfo,pkg.alarmcount,pkg.srcusername,pkg.transfermsg)}}catch(err){SEGUtil_WS.showError("AllotTransferAlarm error:"+err)}};var processAskAlarmListACK=function(content){try{var pkg=segseatlib.builder.build("AskAlarmList_ACK");pkg=pkg.decode(content);if(typeof(onaskalarmlistack)!="undefined"){onaskalarmlistack(selfclient,pkg.retcode,pkg.retmsg,pkg.alarms,pkg.alarmscount)}}catch(err){SEGUtil_WS.showError("AskAlarmList ACK error:"+err)}};var processNewAlarmACK=function(content){try{var pkg=segseatlib.builder.build("NewAlarm_ACK");pkg=pkg.decode(content);if(typeof(onnewalarmack)!="undefined"){onnewalarmack(selfclient,pkg.retcode,pkg.retmsg,pkg.slaver,pkg.callLetter,pkg.alarmsn)}}catch(err){SEGUtil_WS.showError("AskAlarmList ACK error:"+err)}};this.connect=function(){ismanualclose=false;if(!this.isConnected()){socket=null;if(server==null||server.length==0){return}if(serverid<0||serverid>=server.length){serverid=0}var url="ws://"+server[serverid]+"/websocket/";if(server.length>1){serverid++}socket=new WebSocket(url);socket.binaryType="arraybuffer";socket.onerror=function(event){selfclient.errorEvent(event)};socket.onopen=function(event){selfclient.openEvent(event)};socket.onclose=function(event){selfclient.closeEvent(event)};socket.onmessage=function(event){selfclient.receiveEvent(event)}}};this.timeout=function(){var nowtime=new Date().getTime()-lasttime;if(selfclient.isLogined()){if(nowtime>segseatlib.heartbeatinterval){selfclient.activelink()}}if(selfclient.isConnected()&&(loginstatus==0)&&nowtime>2000){lasttime=new Date().getTime();login()}};this.close=function(){ismanualclose=true;if(this.isConnected()){logout();socket.close()}};segseatlib.addClient(selfclient)},Utils:{seg_EN_KEY:[7,2,5,4,0,1,3,6],seg_DE_KEY:[4,5,1,6,3,2,7,0],encrypt:function(buff){var length=buff.byteLength||buff.length;for(var i=0;i<length;i++){var tmp=0;var bit=0;for(var j=0;j<8;j++){bit=(1<<this.seg_EN_KEY[j]);if((buff[i]&bit)!=0){tmp|=(1<<j)}}buff[i]=tmp}return buff},decrypt:function(buff){var length=buff.byteLength||buff.length;for(var i=0;i<length;i++){var tmp=0;var bit=0;for(var j=0;j<8;j++){bit=(1<<this.seg_DE_KEY[j]);if((buff[i]&bit)!=0){tmp|=(1<<j)}}buff[i]=tmp}return buff},compress:function(src){try{var arr=new Uint8Array(src);var deflate=new Zlib.Deflate(arr);arr=deflate.compress();return arr}catch(err){SEGUtil_WS.showError("压缩失败:"+err)}return null},decompress:function(src){try{var arr=new Uint8Array(src);var inflate=new Zlib.Inflate(arr);arr=inflate.decompress();return arr}catch(err){SEGUtil_WS.showError("解压缩失败:"+err)}return null},byteArrayCopy:function(dst,start,src,begin,end){if(typeof(begin)==="undefined"){begin=0}if(typeof(end)==="undefined"){end=src.byteLength}for(var i=begin;i<end&&i<src.byteLength;i++){dst[start+i-begin]=src[i]}},int32ToByteArray:function(buff,start,v){buff[start]=(v>>>24)&255;buff[start+1]=(v>>>16)&255;buff[start+2]=(v>>>8)&255;buff[start+3]=(v)&255},},};